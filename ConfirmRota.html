<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Rota | Solura</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --navy-blue: #001f3f;
            --light-blue: #0074D9;
            --sky-blue: #7FDBFF;
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: var(--white);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        nav {
            background-color: var(--navy-blue);
            color: var(--white);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 10px;
            color: var(--sky-blue);
        }

        .nav-links {
            display: flex;
            list-style: none;
        }

        .nav-links li {
            margin-left: 2rem;
        }

        .nav-links a {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            display: flex;
            align-items: center;
        }

        .nav-links a:hover {
            color: var(--sky-blue);
        }

        .nav-links i {
            margin-right: 5px;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        h1 {
            color: var(--navy-blue);
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
            position: relative;
            padding-bottom: 10px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background-color: var(--light-blue);
        }

        .controls-container {
            background-color: var(--light-gray);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        label {
            font-weight: 500;
            color: var(--navy-blue);
            min-width: 100px;
        }

        select, input[type="date"], input[type="time"] {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        select:focus, input[type="date"]:focus, input[type="time"]:focus {
            outline: none;
            border-color: var(--light-blue);
            box-shadow: 0 0 0 0.2rem rgba(0, 116, 217, 0.25);
        }

        /* Buttons */
        .btn {
            background-color: var(--light-blue);
            color: var(--white);
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background-color: var(--navy-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn i {
            font-size: 1rem;
        }

        .btn-remove {
            background-color: #dc3545;
        }

        .btn-remove:hover {
            background-color: #c82333;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--white);
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        th {
            background-color: var(--navy-blue);
            color: var(--white);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        tr:nth-child(even) {
            background-color: var(--light-gray);
        }

        tr:hover {
            background-color: var(--medium-gray);
        }

        .status-confirmed1 {
            color: #28a745;
            font-weight: 600;
        }

        .status-pending1 {
            color: #dc3545;
            font-weight: 600;
        }

        /* Footer */
        footer {
            background-color: var(--navy-blue);
            color: var(--white);
            text-align: center;
            padding: 1.5rem;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
            }

            .nav-links {
                margin-top: 1rem;
                width: 100%;
                justify-content: space-around;
            }

            .nav-links li {
                margin-left: 0;
            }

            .controls-container {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                flex-direction: column;
                align-items: flex-start;
            }

            th, td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }
        }

        /* Custom styles for time inputs */
        .time-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .time-separator {
            font-weight: bold;
            color: var(--navy-blue);
        }

        /* Message styles */
        .message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 500;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="Admin.html" class="logo">
                <i class="fas fa-calendar-alt"></i>
                <span>Solura Admin</span>
            </a>
            <ul class="nav-links">
                <li><a href="/rota"><i class="fas fa-calendar-plus"></i> Rota</a></li>
                <li><a href="/updateinfo"><i class="fas fa-users"></i> Employees</a></li>
                <li><a href="/tip"><i class="fas fa-money-bill-wave"></i> Tips</a></li>
                <li><a href="/"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <h1>Confirm Rota</h1>
        
        <!-- Controls Section -->
        <div class="controls-container fade-in">
            <div class="control-group">
                <label for="rotaDate"><i class="fas fa-calendar-day"></i> Select Date:</label>
                <input type="date" id="rotaDate" class="date-input">
            </div>
            
            <div class="control-group">
                <label for="employeeDropdown"><i class="fas fa-user-plus"></i> Add Employee:</label>
                <select id="employeeDropdown" class="employee-select"></select>
                <button id="addEmployeeButton" class="btn">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="message" style="display: none;"></div>

        <!-- Table Container -->
        <div class="table-container fade-in">
            <table id="rotaTable">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Name</th>
                        <th>Last Name</th>
                        <th>Designation</th>
                        <th>Working Hours</th>
                        <th>Action</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Action Buttons -->
        <div style="text-align: center; margin-top: 2rem;">
            <button id="confirmButton" class="btn" style="display: none;">
                <i class="fas fa-check-circle"></i> Confirm Rota
            </button>
            <button id="updateButton" class="btn" style="display: none;">
                <i class="fas fa-sync-alt"></i> Update Rota
            </button>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <p>&copy; Solura Ltd 2024, All rights reserved</p>
        </div>
    </footer>
    <script>
        // Session monitor - add this to all pages
let sessionCheckInterval;

function startSessionMonitor() {
    sessionCheckInterval = setInterval(() => {
        fetch('/api/validate-session')
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    console.log('Session expired, redirecting to login');
                    clearInterval(sessionCheckInterval);
                    window.location.href = '/';
                }
            })
            .catch(error => {
                console.error('Session check failed:', error);
            });
    }, 30000); // Check every 30 seconds
}

// Check session on page load
document.addEventListener('DOMContentLoaded', () => {
    fetch('/api/validate-session')
        .then(response => response.json())
        .then(data => {
            if (!data.valid) {
                window.location.href = '/';
            } else {
                startSessionMonitor();
            }
        })
        .catch(error => {
            console.error('Initial session check failed:', error);
            window.location.href = '/';
        });
});
        // Function to get Rota Data by Date
        async function getRotaByDate(date) {
            showLoading(true);
            try {
                const response = await fetch(`/confirmrota/api/rota?day=${encodeURIComponent(date)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                showMessage(`Error fetching rota data: ${error.message}`, 'error');
                return [];
            } finally {
                showLoading(false);
            }
        }

        // Function to Format the Date to Display
        function formatDateForDisplay(date) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }

            if (isNaN(date.getTime())) {
                console.error('Invalid date:', date);
                return '';
            }

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const dayOfWeek = daysOfWeek[date.getDay()];

            return `${day}/${month}/${year} (${dayOfWeek})`;
        }

        // Frontend checkConfirmedRota2 function with enhanced logging
        async function checkConfirmedRota2(date) {
    console.log(`[checkConfirmedRota2] Checking confirmation for date: ${date}`);
    showLoading(true);
    try {
        const url = `/confirmrota/api/check-confirmed-rota2?day=${encodeURIComponent(date)}`;
        console.log(`[checkConfirmedRota2] Fetching from: ${url}`);
        
        const response = await fetch(url);
        if (!response.ok) {
            console.error(`[checkConfirmedRota2] HTTP error! Status: ${response.status}`);
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`[checkConfirmedRota2] Response data:`, data);
        
        return data; // Return the full response data
    } catch (error) {
        console.error(`[checkConfirmedRota2] Error:`, error);
        showMessage(`Error checking confirmed rota: ${error.message}`, 'error');
        return { exists: false, confirmers: [] };
    } finally {
        showLoading(false);
    }
}

// Updated populateTable function with proper data handling
async function populateTable(date) {
    console.log(`[populateTable] Starting for date: ${date}`);
    showLoading(true);
    try {
        const formattedDate = formatDateForDisplay(date);
        console.log(`[populateTable] Formatted date: ${formattedDate}`);
        
        // Get confirmation data
        const confirmationData = await checkConfirmedRota2(formattedDate);
        console.log(`[populateTable] Confirmation data:`, confirmationData);
        
        // Display status message
        const statusMessage = document.getElementById('statusMessage');
        if (confirmationData.exists) {
            if (confirmationData.confirmers && confirmationData.confirmers.length > 0) {
                let namesText;
                if (confirmationData.confirmers.length === 1) {
                    namesText = confirmationData.confirmers[0];
                } else if (confirmationData.confirmers.length === 2) {
                    namesText = confirmationData.confirmers.join(' and ');
                } else {
                    namesText = confirmationData.confirmers.slice(0, -1).join(', ') + 
                               ' and ' + confirmationData.confirmers[confirmationData.confirmers.length - 1];
                }
                statusMessage.textContent = `This rota has already been confirmed by ${namesText}.`;
            } else {
                statusMessage.textContent = 'This rota has already been confirmed.';
            }
            statusMessage.className = 'message message-success';
        } else {
            statusMessage.textContent = 'This rota is pending confirmation.';
            statusMessage.className = 'message message-error';
        }
        statusMessage.style.display = 'block';
        console.log(`[populateTable] Status message set to: ${statusMessage.textContent}`);

        // Rest of your table population logic...
        const [rotaData, confirmedRotaData] = await Promise.all([
            getRotaByDate(formattedDate), 
            getConfirmedRota(formattedDate)
        ]);
        
        console.log(`[populateTable] Rota data:`, rotaData);
        console.log(`[populateTable] Confirmed rota data:`, confirmedRotaData);
                const tableBody = document.querySelector('#rotaTable tbody');
                tableBody.innerHTML = '';

                if (rotaData.length === 0 && confirmedRotaData.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 7;
                    cell.textContent = "No rota data found for the selected date.";
                    cell.style.textAlign = 'center';
                    cell.style.padding = '2rem';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                } else {
                    const allRotaData = [...rotaData, ...confirmedRotaData];
                    
                    // Sort rotaData by designation (FOH first, then BOH)
                    allRotaData.sort((a, b) => {
                        if (a.designation === 'FOH' && b.designation === 'BOH') return -1;
                        if (a.designation === 'BOH' && b.designation === 'FOH') return 1;
                        return 0;
                    });

                    // Group rotaData by name, designation, and day
                    const groupedData = allRotaData.reduce((acc, entry) => {
                        const key = `${entry.day} ${entry.name} ${entry.lastName} ${entry.designation}`;
                        if (!acc[key]) {
                            acc[key] = {
                                day: entry.day,
                                name: entry.name,
                                lastName: entry.lastName,
                                wage: entry.wage,
                                designation: entry.designation,
                                times: []
                            };
                        }
                        acc[key].times.push({ startTime: entry.startTime, endTime: entry.endTime });
                        return acc;
                    }, {});

                    // Loop through each entry in groupedData
                    Object.values(groupedData).forEach(entry => {
                        const row = document.createElement('tr');
                        row.className = 'fade-in';

                        // Day cell
                        const dayCell = document.createElement('td');
                        dayCell.textContent = entry.day;
                        row.appendChild(dayCell);

                        // Name cell
                        const nameCell = document.createElement('td');
                        nameCell.textContent = entry.name;
                        row.appendChild(nameCell);

                        // Last name cell
                        const lastNameCell = document.createElement('td');
                        lastNameCell.textContent = entry.lastName;
                        row.appendChild(lastNameCell);

                        // Designation cell
                        const designationCell = document.createElement('td');
                        designationCell.textContent = entry.designation;
                        row.appendChild(designationCell);

                        // Times cell
                        const timesCell = document.createElement('td');
                        
                        // Create time input groups
                        for (let i = 0; i < 2; i++) {
                            const timeGroup = document.createElement('div');
                            timeGroup.className = 'time-input-group';
                            
                            const { startTime = '', endTime = '' } = entry.times[i] || {};
                            
                            const startTimeInput = createTimeInput('start', i, entry, startTime);
                            const separator = document.createElement('span');
                            separator.className = 'time-separator';
                            separator.textContent = '-';
                            const endTimeInput = createTimeInput('end', i, entry, endTime);
                            
                            timeGroup.appendChild(startTimeInput);
                            timeGroup.appendChild(separator);
                            timeGroup.appendChild(endTimeInput);
                            
                            timesCell.appendChild(timeGroup);
                        }
                        
                        row.appendChild(timesCell);

                        // Remove button cell
                        const removeCell = document.createElement('td');
                        const removeButton = document.createElement('button');
                        removeButton.textContent = "Remove";
                        removeButton.className = 'btn btn-remove';
                        removeButton.innerHTML = '<i class="fas fa-trash-alt"></i> Remove';
                        
                        removeButton.addEventListener('click', () => removeEmployee(entry, row));
                        removeCell.appendChild(removeButton);
                        row.appendChild(removeCell);

                        // Status cell
                        const statusCell = document.createElement('td');
                        const isConfirmed = confirmedRotaData.some(confirmedEntry =>
                            `${confirmedEntry.day} ${confirmedEntry.name} ${confirmedEntry.lastName} ${confirmedEntry.designation}` === 
                            `${entry.day} ${entry.name} ${entry.lastName} ${entry.designation}`
                        );
                        
                        statusCell.innerHTML = isConfirmed 
                            ? '<span class="status-confirmed1"><i class="fas fa-check-circle"></i> Confirmed</span>' 
                            : '<span class="status-pending1"><i class="fas fa-clock"></i> Pending</span>';
                        row.appendChild(statusCell);
                        
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                showMessage(`Error populating table: ${error.message}`, 'error');
            } finally {
                showLoading(false);
                checkAndUpdateRotaButton();
            }
        }

        // Helper function to create time inputs
        function createTimeInput(timeType, index, entry, value) {
            const input = document.createElement('input');
            input.type = 'time';
            input.value = value;
            input.dataset.timeIndex = index;
            input.dataset.name = entry.name;
            input.dataset.lastName = entry.lastName;
            input.dataset.designation = entry.designation;
            input.dataset.timeType = timeType;
            input.className = 'time-input';
            
            input.addEventListener('change', () => {
                updateStatusToPending(input.closest('tr'));
            });
            
            return input;
        }

        // Helper function to update the status to 'Pending' when time is changed
        function updateStatusToPending(row) {
            const statusCell = row.querySelector('td:last-child');
            if (statusCell) {
                statusCell.innerHTML = '<span class="status-pending"><i class="fas fa-clock"></i> Pending</span>';
            }
        }

        // Function to Modify the Button Accordingly
        async function checkAndUpdateRotaButton() {
            try {
                const statusCells = document.querySelectorAll('#rotaTable tbody tr td:last-child');
                let allConfirmed = true;
                let allPending = true;

                statusCells.forEach(cell => {
                    const statusText = cell.textContent.trim().toLowerCase();
                    if (statusText !== 'confirmed') allConfirmed = false;
                    if (statusText !== 'pending') allPending = false;
                });

                const confirmButton = document.getElementById('confirmButton');
                const updateButton = document.getElementById('updateButton');

                if (statusCells.length === 0) {
                    confirmButton.style.display = 'none';
                    updateButton.style.display = 'none';
                    return;
                }

                if (allConfirmed) {
                    confirmButton.style.display = 'none';
                    updateButton.style.display = 'inline-block';
                } else if (allPending) {
                    confirmButton.style.display = 'inline-block';
                    updateButton.style.display = 'none';
                } else {
                    confirmButton.style.display = 'none';
                    updateButton.style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Error checking and updating rota button:', error);
            }
        }

        // Function to get Employees 
        async function fetchEmployees() {
            showLoading(true);
            try {
                const response = await fetch('/confirmrota/api/employees');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const employees = await response.json();
                const employeeDropdown = document.getElementById('employeeDropdown');
                employeeDropdown.innerHTML = '<option value="">Select Employee</option>';

                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = `${employee.name} ${employee.lastName} ${employee.designation}`;
                    option.textContent = `${employee.name} ${employee.lastName} (${employee.designation})`;
                    option.dataset.name = employee.name;
                    option.dataset.lastName = employee.lastName;
                    option.dataset.designation = employee.designation;
                    employeeDropdown.appendChild(option);
                });
            } catch (error) {
                showMessage(`Error fetching employees: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Function to Confirm the Rota
        async function confirmRota() {
            showLoading(true, 'confirmButton');
            try {
                const tableRows = document.querySelectorAll('#rotaTable tbody tr');
                const formattedData = Array.from(tableRows).map(row => {
                    const day = row.querySelector('td:nth-child(1)').textContent;
                    const name = row.querySelector('td:nth-child(2)').textContent;
                    const lastName = row.querySelector('td:nth-child(3)').textContent;
                    const designation = row.querySelector('td:nth-child(4)').textContent;

                    const timeInputs = row.querySelectorAll('input[type="time"]');
                    const times = [];

                    for (let i = 0; i < timeInputs.length; i += 2) {
                        const startTimeInput = timeInputs[i];
                        const endTimeInput = timeInputs[i + 1];

                        if (startTimeInput && endTimeInput && startTimeInput.value && endTimeInput.value) {
                            times.push({
                                startTime: startTimeInput.value,
                                endTime: endTimeInput.value
                            });
                        }
                    }

                    return {
                        name,
                        lastName,
                        day,
                        designation,
                        times
                    };
                });

                const filteredData = formattedData.filter(data => data.times.length > 0);

                const response = await fetch('/confirmrota/confirm-rota', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filteredData)
                });

                if (response.ok) {
                    showMessage('Rota confirmed successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to confirm rota');
                }
            } catch (error) {
                showMessage(`Error confirming rota: ${error.message}`, 'error');
            } finally {
                showLoading(false, 'confirmButton');
            }
        }

        // Function to get the Confirmed Rota by date
        async function getConfirmedRota(dateString) {
            showLoading(true);
            try {
                const dateParts = dateString.split(' ')[0];
                const [day, month, year] = dateParts.split('/');
                const date = new Date(`${month}/${day}/${year}`);

                if (isNaN(date.getTime())) {
                    console.error('Invalid date:', date);
                    return [];
                }

                const formattedDate = formatDateForDisplay(date);
                const response = await fetch(`/confirmrota/api/confirmed-rota?day=${encodeURIComponent(formattedDate)}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                showMessage(`Error fetching confirmed rota: ${error.message}`, 'error');
                return [];
            } finally {
                showLoading(false);
            }
        }

        // Function to Update Rota with All Data for the Day
        async function updateRotaData() {
            showLoading(true, 'updateButton');
            try {
                const table = document.querySelector('#rotaTable tbody');
                const rows = table.querySelectorAll('tr');
                const updatedData = [];

                rows.forEach(row => {
                    const day = row.querySelector('td:nth-child(1)').textContent.trim();
                    const name = row.querySelector('td:nth-child(2)').textContent.trim();
                    const lastName = row.querySelector('td:nth-child(3)').textContent.trim();
                    const designation = row.querySelector('td:nth-child(4)').textContent.trim();

                    if (!day || !name || !lastName || !designation) {
                        console.warn(`Skipping row with missing data: ${row}`);
                        return;
                    }

                    const timeInputs = row.querySelectorAll('.time-input');

                    for (let i = 0; i < timeInputs.length; i += 2) {
                        const startTime = timeInputs[i]?.value.trim();
                        const endTime = timeInputs[i + 1]?.value.trim();

                        const timeRegex = /^\d{2}:\d{2}(:\d{2})?$/;
                        if (startTime && endTime && timeRegex.test(startTime) && timeRegex.test(endTime)) {
                            updatedData.push({
                                day,
                                name,
                                lastName,
                                designation,
                                startTime,
                                endTime,
                                source: 'client'
                            });
                        } else if (startTime || endTime) {
                            console.warn(`Invalid time input for row: StartTime="${startTime}", EndTime="${endTime}"`);
                        }
                    }
                });

                if (updatedData.length === 0) {
                    showMessage('No valid data to update.', 'error');
                    return;
                }

                const response = await fetch('/confirmrota/updateRotaData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('Rota data updated successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    throw new Error(data.message || 'Failed to update rota data');
                }
            } catch (error) {
                showMessage(`Error updating rota: ${error.message}`, 'error');
            } finally {
                showLoading(false, 'updateButton');
            }
        }

        // Function to Add the Employees to Add into the Table
        async function addEmployeeToTable() {
            showLoading(true, 'addEmployeeButton');
            try {
                const dropdown = document.getElementById('employeeDropdown');
                const selectedOption = dropdown.options[dropdown.selectedIndex];

                if (!selectedOption || selectedOption.value === "") {
                    showMessage('Please select an employee from the dropdown.', 'error');
                    return;
                }

                const name = selectedOption.dataset.name;
                const lastName = selectedOption.dataset.lastName;
                const designation = selectedOption.dataset.designation;

                const rows = document.querySelectorAll('#rotaTable tbody tr');
                const dayInput = rows[0]?.querySelector('td:nth-child(1)').textContent.trim();
                const dateMatch = dayInput.match(/^(\d{2}\/\d{2}\/\d{4}) \((\w+)\)$/);

                if (!dateMatch) {
                    showMessage('Invalid date format in table.', 'error');
                    return;
                }

                const dayDate = dateMatch[1];
                const weekday = dateMatch[2];
                const day = `${dayDate} (${weekday})`;

                // Check if employee already exists
                let employeeExists = false;
                rows.forEach(row => {
                    const rowName = row.querySelector('td:nth-child(2)').textContent.trim();
                    const rowLastName = row.querySelector('td:nth-child(3)').textContent.trim();

                    if (rowName === name && rowLastName === lastName) {
                        employeeExists = true;
                    }
                });

                if (employeeExists) {
                    const userConfirmed = confirm(`${name} ${lastName} is already in the Rota. Do you want to add them again?`);
                    if (!userConfirmed) return;
                }

                const tableBody = document.querySelector('#rotaTable tbody');
                if (!tableBody) {
                    showMessage('Table body not found!', 'error');
                    return;
                }

                const row = document.createElement('tr');
                row.className = 'fade-in';

                // Day cell
                const dayCell = document.createElement('td');
                dayCell.textContent = day;
                row.appendChild(dayCell);

                // Name cell
                const nameCell = document.createElement('td');
                nameCell.textContent = name;
                row.appendChild(nameCell);

                // Last name cell
                const lastNameCell = document.createElement('td');
                lastNameCell.textContent = lastName;
                row.appendChild(lastNameCell);

                // Designation cell
                const designationCell = document.createElement('td');
                designationCell.textContent = designation;
                row.appendChild(designationCell);

                // Times cell with two pairs of time inputs
                const timesCell = document.createElement('td');
                for (let i = 0; i < 2; i++) {
                    const timeGroup = document.createElement('div');
                    timeGroup.className = 'time-input-group';
                    
                    const startTimeInput = createTimeInput('start', i, { name, lastName, designation }, '');
                    const separator = document.createElement('span');
                    separator.className = 'time-separator';
                    separator.textContent = '-';
                    const endTimeInput = createTimeInput('end', i, { name, lastName, designation }, '');
                    
                    timeGroup.appendChild(startTimeInput);
                    timeGroup.appendChild(separator);
                    timeGroup.appendChild(endTimeInput);
                    
                    timesCell.appendChild(timeGroup);
                }
                row.appendChild(timesCell);

                // Remove button cell
                const removeCell = document.createElement('td');
                const removeButton = document.createElement('button');
                removeButton.className = 'btn btn-remove';
                removeButton.innerHTML = '<i class="fas fa-trash-alt"></i> Remove';
                removeButton.addEventListener('click', () => removeEmployee({
                    name,
                    lastName,
                    designation,
                    day
                }, row));
                removeCell.appendChild(removeButton);
                row.appendChild(removeCell);

                // Status cell (default to pending)
                const statusCell = document.createElement('td');
                statusCell.innerHTML = '<span class="status-pending"><i class="fas fa-clock"></i> Pending</span>';
                row.appendChild(statusCell);

                tableBody.appendChild(row);
                showMessage(`${name} ${lastName} added to rota.`, 'success');
            } catch (error) {
                showMessage(`Error adding employee: ${error.message}`, 'error');
            } finally {
                showLoading(false, 'addEmployeeButton');
                checkAndUpdateRotaButton();
            }
        }

        // Function to remove an employee
        async function removeEmployee(employee, row) {
            if (!confirm(`Are you sure you want to remove ${employee.name} ${employee.lastName} from the rota?`)) {
                return;
            }

            showLoading(true);
            try {
                row.remove();
                
                const data = {
                    name: employee.name,
                    lastName: employee.lastName,
                    designation: employee.designation,
                    day: employee.day,
                };

                const response = await fetch('/confirmrota/delete-employee', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showMessage(`Successfully removed ${employee.name} ${employee.lastName} from the rota.`, 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to remove employee');
                }
            } catch (error) {
                showMessage(`Error removing employee: ${error.message}`, 'error');
            } finally {
                showLoading(false);
                checkAndUpdateRotaButton();
            }
        }

        // Function to create the calendar visualization
        async function createRotaCalendar() {
    // Create calendar container if it doesn't exist
    let calendarContainer = document.querySelector('.calendar-container');
    if (!calendarContainer) {
        calendarContainer = document.createElement('div');
        calendarContainer.className = 'calendar-container';
        
        // Insert before the main content
        const main = document.querySelector('main');
        main.insertBefore(calendarContainer, main.firstChild);
    }
    
    calendarContainer.innerHTML = `
        <h2 style="font-size: 1.2rem; margin-bottom: 0.5rem;">Rota Status Calendar</h2>
        <div class="calendar-controls">
            <button id="prevMonth" class="btn calendar-nav" style="padding: 0.3rem 0.8rem;"><i class="fas fa-chevron-left"></i></button>
            <h3 id="currentMonthYear" style="margin: 0 0.5rem; font-size: 1rem;"></h3>
            <button id="nextMonth" class="btn calendar-nav" style="padding: 0.3rem 0.8rem;"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <div class="calendar-legend" style="margin-top: 0.5rem; font-size: 0.8rem;">
            <div><span class="legend-confirmed"></span> Confirmed</div>
            <div><span class="legend-pending"></span> Pending</div>
            <div><span class="legend-no-data"></span> No Data</div>
        </div>
    `;
    
    // Add compact styles
    const style = document.createElement('style');
    style.textContent = `
        .calendar-container {
            margin-bottom: 1rem;
            padding: 0.8rem;
            background: #f8f9fa;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day {
            padding: 4px 2px;
            text-align: center;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .calendar-day:hover {
            transform: scale(1.03);
            background: rgba(0,0,0,0.05);
        }
        .calendar-day-header {
            font-weight: bold;
            text-align: center;
            padding: 2px;
            font-size: 0.8rem;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 0.85rem;
        }
        .day-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 auto;
        }
        .status-confirmed {
            background-color: #28a745;
        }
        .status-pending {
            background-color: #dc3545;
        }
        .status-no-data {
            background-color: #6c757d;
        }
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }
        .calendar-legend span {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 3px;
        }
        .legend-confirmed {
            background-color: #28a745;
        }
        .legend-pending {
            background-color: #dc3545;
        }
        .legend-no-data {
            background-color: #6c757d;
        }
        .calendar-nav {
            min-width: 30px;
        }
    `;
    document.head.appendChild(style);
    
    // Initialize calendar with current month
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    
    // Render the calendar
    renderCalendar(currentMonth, currentYear);
    
    // Event listeners for navigation
    document.getElementById('prevMonth').addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentMonth, currentYear);
    });
    
    document.getElementById('nextMonth').addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentMonth, currentYear);
    });

    // Modified renderCalendar function with Monday as first day
    async function renderCalendar(month, year) {
        const monthNames = ["January", "February", "March", "April", "May", "June",
                           "July", "August", "September", "October", "November", "December"];
        
        document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
        
        const firstDay = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Adjust to make Monday the first day (0 = Sunday, 1 = Monday, etc.)
        let firstDayOfWeek = firstDay.getDay();
        if (firstDayOfWeek === 0) firstDayOfWeek = 6; // Sunday becomes 6
        else firstDayOfWeek--; // Other days shift down by 1
        
        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = '';
        
        // Day headers starting with Monday
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        dayNames.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
        });
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < firstDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty-day';
            calendarGrid.appendChild(emptyDay);
        }
        
        // Add days of the current month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayElement.appendChild(dayNumber);
            
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'day-status status-no-data';
            dayElement.appendChild(statusIndicator);
            
            calendarGrid.appendChild(dayElement);
            
            dayElement.addEventListener('click', () => {
    // Use the dataset.date directly (it's already in yyyy-mm-dd format)
    document.getElementById('rotaDate').value = dayElement.dataset.date;
    populateTable(dayElement.dataset.date);
});
        }
        
        await updateCalendarStatuses(month, year);
    }
}

        // Helper function to format date for calendar
        function formatDateForCalendar(dateString) {
    // Parse the yyyy-mm-dd format
    const [year, month, day] = dateString.split('-');
    const date = new Date(year, month - 1, day);
    
    const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const dayOfWeek = daysOfWeek[date.getDay()];
    
    return `${day}/${month}/${year} (${dayOfWeek})`;
}
        
        // Function to Update Calendar Status
        async function updateCalendarStatuses(month, year) {
    try {
        // Fetch confirmed rotas for this month using updated endpoint
        const response = await fetch(`/confirmrota/api/confirmed-rota-month?year=${year}&month=${month + 1}`);
        if (!response.ok) throw new Error('Failed to fetch confirmed rotas');

        const { data } = await response.json(); // 'data' is a grouped object

        // Create a Set of confirmed dates (in dd/mm/yyyy format)
        const confirmedSet = new Set(Object.keys(data));

        // Process each calendar day
        const calendarDays = document.querySelectorAll('.calendar-day:not(.empty-day)');

        const dayProcessing = Array.from(calendarDays).map(async (dayElement) => {
            const date = new Date(dayElement.dataset.date);
            if (isNaN(date.getTime())) return;

            const day = String(date.getDate()).padStart(2, '0');
            const monthFormatted = String(date.getMonth() + 1).padStart(2, '0');
            const formattedDate = `${day}/${monthFormatted}/${date.getFullYear()}`;

            const statusIndicator = dayElement.querySelector('.day-status');
            if (!statusIndicator) return;

            // Confirmed
            if (confirmedSet.has(formattedDate)) {
                statusIndicator.className = 'day-status status-confirmed';
            } else {
                // Pending or No Data
                const weekday = date.toLocaleDateString('en-US', { weekday: 'long' });
                const fullFormattedDate = `${formattedDate} (${weekday})`;

                const rotaData = await getRotaByDate(fullFormattedDate);
                statusIndicator.className = rotaData?.length > 0
                    ? 'day-status status-pending'
                    : 'day-status status-no-data';
            }
        });

        await Promise.all(dayProcessing);

    } catch (error) {
        console.error('Error updating calendar statuses:', error);
        showMessage('Error loading calendar statuses', 'error');
    }
}

        // Helper function to show loading state
        function showLoading(isLoading, elementId = null) {
            if (elementId) {
                const button = document.getElementById(elementId);
                if (button) {
                    if (isLoading) {
                        button.disabled = true;
                        button.innerHTML = `<span class="spinner"></span> Processing...`;
                    } else {
                        button.disabled = false;
                        if (elementId === 'confirmButton') {
                            button.innerHTML = `<i class="fas fa-check-circle"></i> Confirm Rota`;
                        } else if (elementId === 'updateButton') {
                            button.innerHTML = `<i class="fas fa-sync-alt"></i> Update Rota`;
                        } else if (elementId === 'addEmployeeButton') {
                            button.innerHTML = `<i class="fas fa-plus"></i> Add`;
                        }
                    }
                }
            }
        }

        // Helper function to show messages
        function showMessage(message, type) {
            const messageElement = document.getElementById('statusMessage');
            messageElement.textContent = message;
            messageElement.className = `message message-${type === 'error' ? 'error' : 'success'}`;
            messageElement.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }

        // Event Listeners
        document.getElementById('rotaDate').addEventListener('change', function() {
            populateTable(this.value);
        });

        document.getElementById('addEmployeeButton').addEventListener('click', addEmployeeToTable);
        document.getElementById('confirmButton').addEventListener('click', confirmRota);
        document.getElementById('updateButton').addEventListener('click', updateRotaData);

        // Initialize the page
        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rotaDate').value = today;
            populateTable(today);
            fetchEmployees();
            createRotaCalendar(); // Add this line
        };
    </script>
</body>
</html>