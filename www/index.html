<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enterprise Login | Data Management Suite</title>
    <!-- Your existing CSS styles go here -->
    <style>
        :root{--primary-color:#001f3f;--secondary-color:#003366;--accent-color:#0074D9;--success-color:#28a745;--light-accent:#7FDBFF;--text-color:#333;--light-text:#666;--background-color:#fff;--input-bg:#f8f9fa;--border-radius:16px;--shadow:0 8px 32px rgba(0,31,63,.1);--gradient:linear-gradient(135deg,#001f3f 0%,#0074D9 100%)}*
        {box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;height:100vh;overflow:hidden;background:var(--background-color);background-image:linear-gradient(135deg,rgba(0,31,63,.05) 0%,#fff 100%);color:var(--text-color);display:flex;flex-direction:column;padding:0;position:fixed;width:100%;height:100%}.login-container{background:var(--background-color);padding:2rem 1.5rem;width:100%;height:100%;text-align:center;display:flex;flex-direction:column;justify-content:center;position:relative;overflow-y:auto}.login-header{margin-bottom:2rem}.logo-container{width:100px;height:100px;margin:0 auto 1.5rem;background:var(--gradient);border-radius:25px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:36px;font-weight:700;box-shadow:var(--shadow);position:relative;overflow:hidden}.logo-container::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(255,255,255,.1),transparent);transform:rotate(45deg)}.login-container h2{color:var(--primary-color);font-size:28px;margin-bottom:.5rem;font-weight:700;letter-spacing:-.5px}.login-container p{color:var(--light-text);margin-bottom:2rem;font-size:16px;line-height:1.6;padding:0 1rem}.login-form{max-width:400px;margin:0 auto;width:100%}.form-group{margin-bottom:1.5rem;text-align:left}.form-group label{display:block;font-weight:600;margin-bottom:.75rem;color:var(--primary-color);font-size:14px;text-transform:uppercase;letter-spacing:.5px}.input-container{position:relative}.form-group input{width:100%;padding:18px 20px;border:2px solid #e9ecef;border-radius:var(--border-radius);font-size:16px;background-color:var(--input-bg);transition:all .3s ease;font-weight:500}.form-group input:focus{border-color:var(--accent-color);outline:0;box-shadow:0 0 0 4px rgba(0,116,217,.1);background-color:#fff;transform:translateY(-2px)}.form-group input::placeholder{color:#adb5bd;font-weight:400}.form-group button{background:var(--gradient);color:#fff;padding:18px;border:none;border-radius:var(--border-radius);cursor:pointer;width:100%;font-size:16px;font-weight:600;margin-top:.5rem;letter-spacing:.5px;transition:all .3s ease;box-shadow:var(--shadow);position:relative;overflow:hidden}.form-group button:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,31,63,.2)}.form-group button:active{transform:translateY(0)}.form-group button::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}.form-group button:hover::after{left:100%}.biometric-section{margin:2rem 0 1rem;padding:0;text-align:center}.biometric-divider{display:flex;align-items:center;margin:2rem 0;color:var(--light-text);font-size:14px}.biometric-divider::after,.biometric-divider::before{content:'';flex:1;height:1px;background:#e9ecef}.biometric-divider span{padding:0 1rem}.biometric-btn{background:#fff;color:var(--primary-color);border:2px solid #e9ecef;padding:16px 24px;border-radius:var(--border-radius);cursor:pointer;font-size:16px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:12px;width:100%;transition:all .3s ease;box-shadow:var(--shadow)}.biometric-btn:hover{transform:translateY(-2px);border-color:var(--accent-color);box-shadow:0 8px 25px rgba(0,31,63,.15)}.biometric-btn:active{transform:translateY(0)}.biometric-icon{font-size:20px}.biometric-text{font-size:14px;color:var(--light-text);margin-top:12px}.biometric-error,.biometric-success{padding:12px;border-radius:var(--border-radius);margin-top:1rem;font-size:14px;font-weight:500;display:none}.biometric-error{background:#ffe6e6;color:#dc3545;border:1px solid #ffcccc}.biometric-success{background:#e6ffe6;color:var(--success-color);border:1px solid #ccffcc}.biometric-option{display:flex;align-items:center;justify-content:center;margin:1.5rem 0;padding:1.25rem;background:#f8f9fa;border-radius:var(--border-radius);border:2px solid #e9ecef}.biometric-option label{display:flex;align-items:center;gap:12px;cursor:pointer;font-size:14px;color:var(--text-color);font-weight:500;margin:0}.toggle-switch{position:relative;width:50px;height:26px;background:#ddd;border-radius:13px;transition:all .3s ease}.toggle-switch::after{content:'';position:absolute;width:22px;height:22px;background:#fff;border-radius:50%;top:2px;left:2px;transition:all .3s ease;box-shadow:0 2px 4px rgba(0,0,0,.2)}#enableBiometric:checked+.toggle-switch{background:var(--success-color)}#enableBiometric:checked+.toggle-switch::after{transform:translateX(24px)}#enableBiometric{display:none}.loading{display:none;text-align:center;margin:20px 0}.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid var(--accent-color);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 1rem}.spinner{display:inline-block;width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}@keyframes spin{to{transform:rotate(360deg)}}.error-message{color:#dc3545;margin-top:1rem;padding:1rem;border-radius:var(--border-radius);background-color:#ffe6e6;border:1px solid #ffcccc;display:none;font-weight:500}.powered-by{margin-top:2rem;font-size:12px;color:var(--light-text);padding:0 1rem}#biometricPrompt,#databasePopup,#duplicateSessionModal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:1000;padding:1rem;overflow-y:auto}.modal-content,.popup-content,.prompt-content{background:#fff;border-radius:var(--border-radius);padding:2rem;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;text-align:center;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow)}.popup-content::before,.prompt-content::before{content:'';position:absolute;top:0;left:0;width:100%;height:6px;background:var(--gradient);border-radius:var(--border-radius) var(--border-radius) 0 0}.modal-buttons,.popup-buttons,.prompt-buttons{display:flex;gap:.75rem;margin-top:1.5rem}.modal-buttons button,.popup-buttons button,.prompt-buttons button{flex:1;padding:14px;border:none;border-radius:var(--border-radius);cursor:pointer;font-weight:600;transition:all .3s ease}.primary-btn{background:var(--gradient);color:#fff}.primary-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,31,63,.3)}.close-btn,.secondary-btn{background-color:#f8f9fa;color:var(--text-color);border:2px solid #ddd}.close-btn:hover,.secondary-btn:hover{background-color:#e9ecef;transform:translateY(-2px)}#databaseList{list-style:none;margin:1.5rem 0;max-height:200px;overflow-y:auto}#databaseList li{padding:1rem;margin-bottom:.75rem;border:2px solid #e9ecef;border-radius:var(--border-radius);cursor:pointer;transition:all .3s ease}#databaseList li:hover{border-color:var(--accent-color);background:#f8f9fa;transform:translateY(-2px)}#databaseList li.selected{border-color:var(--accent-color);background:rgba(0,116,217,.05)}@supports (padding:max(0px)){.login-container{padding-left:max(1.5rem,env(safe-area-inset-left));padding-right:max(1.5rem,env(safe-area-inset-right));padding-top:max(2rem,env(safe-area-inset-top));padding-bottom:max(2rem,env(safe-area-inset-bottom))}}
    </style>
</head>
<body>
    <!-- Your existing HTML body content goes here -->
        <div id="databasePopup">
        <div class="popup-content">
            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Select Account</h3>
            <p style="color: var(--light-text); margin-bottom: 1.5rem;">Your account has access to multiple databases. Please select one to continue.</p>
            <ul id="databaseList"></ul>
        </div>
    </div>

    <div id="biometricPrompt">
        <div class="prompt-content">
            <div class="biometric-icon" style="font-size: 48px; margin-bottom: 1rem;">ðŸ”’</div>
            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Enable Biometric Login?</h3>
            <p style="color: var(--light-text); margin-bottom: 1.5rem;">Use Face ID or Touch ID for faster, more secure login next time.</p>
            <div class="prompt-buttons">
                <button id="enableBioBtn" class="primary-btn">Yes, Enable</button>
                <button id="skipBioBtn" class="secondary-btn">Not Now</button>
            </div>
        </div>
    </div>

    <div class="login-container">
        <div class="login-header">
            <div class="logo-container">EDM</div>
            <h2>Welcome Back</h2>
            <p>Sign in to access your Enterprise Data Management Suite.</p>
        </div>

        <div class="biometric-section" id="biometricSection" style="display: none;">
            <button class="biometric-btn" id="biometricBtn">
                <span class="biometric-icon">ðŸ”’</span>
                <span id="biometricBtnText">Sign in with Biometrics</span>
            </button>
            <div class="biometric-error" id="biometricError"></div>
        </div>

        <form class="login-form" id="loginForm">
            <div class="biometric-divider" id="biometricDivider" style="display: none;">
                <span>or sign in with email</span>
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required placeholder="your.email@company.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div class="biometric-option">
                <label>
                    <input type="checkbox" id="enableBiometric">
                    <span class="toggle-switch"></span>
                    Enable biometric authentication
                </label>
            </div>
            <div class="form-group">
                <button type="submit" id="loginButton">Sign In</button>
            </div>
            <div id="errorMessage" class="error-message"></div>
        </form>
    </div>

<script>
    // =================================================================================
    // --- (1) CONFIGURATION ---
    // =================================================================================
    const API_BASE_URL = 'https://www.solura.uk';

    // =================================================================================
    // --- (2) GLOBAL VARIABLES ---
    // =================================================================================
    let currentDeviceFingerprint = null;
    let tempCredentials = {}; // For multi-DB flow

    // =================================================================================
    // --- (3) INITIALIZATION ---
    // =================================================================================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('ðŸš€ Token-based script initialized.');
        
        currentDeviceFingerprint = await generateDeviceFingerprint();
        
        const isNative = window.Capacitor && window.Capacitor.isNativePlatform();
        if (isNative) {
            await initializeBiometricSystem();
        } else {
            document.getElementById('biometricSection').style.display = 'none';
            document.getElementById('biometricDivider').style.display = 'none';
        }

        initializeEventListeners();
    });

    async function initializeBiometricSystem() {
        try {
            const { NativeBiometric } = window.Capacitor.Plugins;
            const available = await NativeBiometric.isAvailable();
            if (available.isAvailable) {
                console.log("âœ… Biometrics available.");
                document.getElementById('biometricSection').style.display = 'block';
                document.getElementById('biometricDivider').style.display = 'flex';
            } else {
                console.log(`- Biometrics not available: ${available.reason}`);
            }
        } catch (e) {
            console.error("Error initializing biometrics", e);
        }
    }

    function initializeEventListeners() {
        document.getElementById('loginForm').addEventListener('submit', handleLoginSubmit);
        document.getElementById('biometricBtn').addEventListener('click', handleBiometricLogin);
        document.getElementById('enableBioBtn').addEventListener('click', handleEnableBiometrics);
        document.getElementById('skipBioBtn').addEventListener('click', () => redirectToDashboard());
        document.getElementById('databaseList').addEventListener('click', (e) => {
            const listItem = e.target.closest('li');
            if (listItem && listItem.dataset.dbName) {
                handleDatabaseSelection(listItem.dataset.dbName);
            }
        });
    }

    // =================================================================================
    // --- (4) CORE AUTHENTICATION FLOW ---
    // =================================================================================

    async function handleLoginSubmit(event) {
        event.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const wantsBiometric = document.getElementById('enableBiometric').checked;

        setLoading(true);
        tempCredentials = { email, password };

        try {
            const response = await makeApiRequest('/submit', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'Login failed');

            if (data.requiresDbSelection) {
                showDatabasePopup(data.databases);
            } else {
                await handleAuthSuccess(data, wantsBiometric);
            }
        } catch (error) {
            showError(error.message);
        } finally {
            setLoading(false);
        }
    }

    async function handleDatabaseSelection(dbName) {
        document.getElementById('databasePopup').style.display = 'none';
        const wantsBiometric = document.getElementById('enableBiometric').checked;
        setLoading(true);

        try {
            const response = await makeApiRequest('/submit', {
                method: 'POST',
                body: JSON.stringify({ ...tempCredentials, dbName })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'Database selection failed');

            await handleAuthSuccess(data, wantsBiometric);
        } catch (error) {
            showError(error.message);
        } finally {
            setLoading(false);
        }
    }

    async function handleBiometricLogin() {
        const btn = document.getElementById('biometricBtn');
        const errorDiv = document.getElementById('biometricError');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Authenticating...';
        errorDiv.style.display = 'none';

        try {
            const { NativeBiometric } = window.Capacitor.Plugins;
            await NativeBiometric.verifyIdentity({ reason: 'Sign in to your account' });
            
            const response = await makeApiRequest('/api/biometric-login', {
                method: 'POST',
                body: JSON.stringify({ deviceFingerprint: currentDeviceFingerprint })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);

            await handleAuthSuccess(data, false); // Don't re-prompt for biometrics

        } catch (error) {
            errorDiv.textContent = error.message || 'Biometric login failed.';
            errorDiv.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span class="biometric-icon">ðŸ”’</span> Sign in with Biometrics';
        }
    }

    async function handleAuthSuccess(data, wantsBiometric) {
        console.log('âœ… Authentication successful.');
        localStorage.setItem('accessToken', data.accessToken);
        localStorage.setItem('refreshToken', data.refreshToken);
        
        // Store data needed for redirect and registration
        sessionStorage.setItem('pendingRedirectUrl', data.redirectUrl);
        
        const isNative = window.Capacitor && window.Capacitor.isNativePlatform();
        if (isNative && wantsBiometric) {
            document.getElementById('biometricPrompt').style.display = 'flex';
        } else {
            redirectToDashboard();
        }
    }

    async function handleEnableBiometrics() {
        document.getElementById('biometricPrompt').style.display = 'none';
        console.log('-> User opted to enable biometrics. Registering device...');

        try {
            const deviceInfo = {
                platform: navigator.platform,
                userAgent: navigator.userAgent
            };
            const response = await makeApiRequest('/api/register-device', {
                method: 'POST',
                body: JSON.stringify({ deviceFingerprint: currentDeviceFingerprint, deviceInfo })
            });

            if (!response.ok) throw new Error('Device registration failed.');
            console.log('âœ… Device registered successfully.');

        } catch (error) {
            console.error('Biometric registration error:', error);
        } finally {
            redirectToDashboard();
        }
    }

    // =================================================================================
    // --- (5) UI & HELPER FUNCTIONS ---
    // =================================================================================

    function redirectToDashboard() {
        const url = sessionStorage.getItem('pendingRedirectUrl');
        if (url) {
            window.location.replace(url);
        } else {
            showError('Could not find redirect information. Please log in again.');
        }
    }

    function showDatabasePopup(databases) {
        const list = document.getElementById('databaseList');
        list.innerHTML = '';
        databases.forEach(db => {
            const li = document.createElement('li');
            li.dataset.dbName = db.db_name;
            li.innerHTML = `<strong>${db.db_name}</strong><br><small>Access: ${db.access}</small>`;
            list.appendChild(li);
        });
        document.getElementById('databasePopup').style.display = 'flex';
    }

    function setLoading(isLoading) {
        const button = document.getElementById('loginButton');
        button.disabled = isLoading;
        button.innerHTML = isLoading ? '<span class="spinner"></span>' : 'Sign In';
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    async function makeApiRequest(url, options = {}) {
        const fullUrl = `${API_BASE_URL}${url}`;
        const headers = { 'Content-Type': 'application/json', ...options.headers };

        const token = localStorage.getItem('accessToken');
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        return fetch(fullUrl, {
            ...options,
            headers,
        });
    }

    async function generateDeviceFingerprint() {
        try {
            const data = {
                platform: navigator.platform,
                language: navigator.language,
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            };
            const jsonString = JSON.stringify(data);
            const msgBuffer = new TextEncoder().encode(jsonString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        } catch (error) {
            console.error('Fingerprint generation failed', error);
            return 'fingerprint-failed';
        }
    }
</script>
</body>
</html>