<!DOCTYPE html>
<html lang="en">
<head>
        <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-768D41J8NJ"></script>
<script>
    // This script runs immediately when the page loads
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            console.log("Token found in URL. Saving to localStorage.");
            // Store the token so we can use it for all future API calls
            localStorage.setItem('accessToken', token);
            // Clean the URL so the token isn't visible
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // We can also add a check here: if there's no token, redirect to login
        if (!localStorage.getItem('accessToken')) {
            // Optional but good for security:
            // window.location.replace('/index.html'); 
        }
    })();
</script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-768D41J8NJ');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Solura | Workforce Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
        :root {
            --primary-color: #004f9e;
            --secondary-color: #007acc;
            --accent-color: #00a8ff;
            --light-gray: #f4f6f9;
            --dark-gray: #333;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-gray);
            color: var(--dark-gray);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 40px; /* <<< SIMPLE SPACE FOR NOTCH */
        }
        
        /* Mobile Header - Fixed positioning to avoid notch */
        .mobile-header {
            background-color: var(--white);
            padding: 1rem;
            box-shadow: var(--shadow);
            position: fixed;
            top: 40px; /* <<< PUSH HEADER BELOW NOTCH */
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0.25rem;
        }

        /* Main Content Area - Add margin top to account for fixed header */
        .mobile-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            margin-top: calc(4rem + constant(safe-area-inset-top)); /* header height + safe area */
            margin-top: calc(4rem + env(safe-area-inset-top));
            margin-bottom: constant(safe-area-inset-bottom);
            margin-bottom: env(safe-area-inset-bottom);
            padding-left: calc(1rem + constant(safe-area-inset-left));
            padding-left: calc(1rem + env(safe-area-inset-left));
            padding-right: calc(1rem + constant(safe-area-inset-right));
            padding-right: calc(1rem + env(safe-area-inset-right));
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .content-title {
            font-size: 1.25rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .date-display {
            font-size: 0.9rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Dashboard Widgets */
        .mobile-dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .mobile-widget {
            background: var(--white);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow);
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .widget-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .widget-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin: 0.25rem 0;
        }
        
        .widget-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Quick Actions */
        .quick-actions-title {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .mobile-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .mobile-action {
            background: var(--white);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            text-decoration: none;
            color: var(--dark-gray);
            transition: transform 0.2s ease;
        }
        
        .mobile-action:active {
            transform: scale(0.98);
        }
        
        .action-icon {
            font-size: 1.5rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }
        
        .action-label {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Data Tables */
        .mobile-table-container {
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }
        
        .mobile-table {
            width: 100%;
            min-width: 500px;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .mobile-table th {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 0.75rem;
            text-align: left;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .mobile-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        .mobile-table tr:last-child td {
            border-bottom: none;
        }
        
        .boh-cell {
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
        }

        .foh-cell {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }

        .status-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
            font-size: 0.8rem;
        }

        .status-indicator.working {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .status-indicator.inactive {
            background-color: #f5f5f5;
            color: #616161;
        }
        
        /* Footer */
        .mobile-footer {
            background: var(--primary-color);
            color: var(--white);
            padding: 1rem;
            text-align: center;
            font-size: 0.8rem;
            /* Safe area for home indicator */
            padding-bottom: calc(1rem + constant(safe-area-inset-bottom));
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }

        /* Mobile Menu - Fixed positioning */
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 85%;
            height: 100%;
            background: var(--white);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            /* Safe area padding */
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .mobile-menu.active {
            left: 0;
        }

        .menu-header {
            padding: 1.5rem 1rem;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Safe area padding */
            padding-top: calc(1.5rem + constant(safe-area-inset-top));
            padding-top: calc(1.5rem + env(safe-area-inset-top));
        }

        .close-menu {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-nav {
            padding: 1rem 0;
        }
        
        .mobile-nav-section {
            margin-bottom: 1rem;
        }
        
        .mobile-nav-title {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--primary-color);
            font-weight: 600;
            background: rgba(0, 122, 204, 0.1);
        }
        
        .mobile-nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: var(--dark-gray);
            text-decoration: none;
            border-bottom: 1px solid #eee;
            gap: 0.75rem;
        }
        
        .mobile-nav-link i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .mobile-nav-link.active {
            background-color: rgba(0, 122, 204, 0.1);
            color: var(--primary-color);
            border-left: 3px solid var(--primary-color);
        }
        
        .notification-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #ff0000;
            border-radius: 50%;
            margin-left: auto;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 5px rgba(255, 0, 0, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        /* Modal */
        .mobile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            /* Safe area padding */
            padding-top: calc(1rem + constant(safe-area-inset-top));
            padding-top: calc(1rem + env(safe-area-inset-top));
            padding-bottom: calc(1rem + constant(safe-area-inset-bottom));
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }
        
        .mobile-modal-content {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.1rem;
            color: #004f9e;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            padding: 1rem;
        }

        /* Overlay for menu */
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .menu-overlay.active {
            display: block;
        }

        /* Loading and Error States */
        .loading-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error-state {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
        }

        .session-error {
            text-align: center;
            padding: 2rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
        }

        /* Fallback for older browsers */
        @supports not (padding: env(safe-area-inset-top)) {
            body {
                padding-top: 20px;
                padding-bottom: 20px;
            }
            
            .mobile-header {
                padding-top: 1rem;
            }
            
            .mobile-content {
                margin-top: 4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <header class="mobile-header">
        <div class="mobile-title">
            <i class="fas fa-calendar-alt"></i>
            <span>Solura Workforce</span>
        </div>
        <button class="mobile-menu-btn" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <!-- Database Switcher -->
        <div id="databaseSwitcher" style="display: inline-block; margin-left: 15px;">
            <select id="databaseSelect" onchange="switchDatabase(this.value)" 
                    style="padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; background: white;">
                <option value="">Loading databases...</option>
            </select>
        </div>
    </header>
    
    <!-- Mobile Menu -->
    <div class="menu-overlay" id="menuOverlay"></div>
    <nav class="mobile-menu" id="mobileMenu">
        <div class="menu-header">
            <span>Menu</span>
            <button class="close-menu" id="closeMenu">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mobile-nav">
            <div class="mobile-nav-section">
                <div class="mobile-nav-title">Management</div>
                <a href="#" class="mobile-nav-link active" onclick="navigateTo('AdminApp.html')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/updateinfo')">
                    <i class="fas fa-users"></i>
                    <span>Employees</span>
                </a>
            </div>
            
            <div class="mobile-nav-section">
                <div class="mobile-nav-title">Daily</div>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/endday')">
                    <i class="fas fa-clock"></i>
                    <span>End Of Day</span>
                </a>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/confirmrota')">
                    <i class="fas fa-check-double"></i>
                    <span>Approve Rota</span>
                </a>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/tip')">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span>Tips</span>
                </a>
            </div>
            
            <div class="mobile-nav-section">
                <div class="mobile-nav-title">Holidays</div>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/TotalHolidays')">
                    <i class="fas fa-calendar-check"></i>
                    <span>Holidays Management</span>
                </a>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/request')">
                    <i class="fas fa-check-circle"></i>
                    <span>Approve/Reject Holidays</span>
                    <span class="notification-badge" id="holidayNotification" style="display: none;"></span>
                </a>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/userholidays')">
                    <i class="fas fa-umbrella-beach"></i>
                    <span>Request Holidays</span>
                </a>
            </div>
            
            <div class="mobile-nav-section">
                <div class="mobile-nav-title">Finance</div>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/hours')">
                    <i class="fas fa-clock"></i>
                    <span>Time Tracking</span>
                </a>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/insertpayslip')">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Insert Payslips</span>
                </a>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/pastpayslips')">
                    <i class="fas fa-receipt"></i>
                    <span>Past Payslips</span>
                </a>
                <a href="#" class="mobile-nav-link" id="reportsLinkMobile">
                    <i class="fas fa-chart-line"></i>
                    <span>Reports</span>
                </a>
            </div>
            
            <div class="mobile-nav-section">
                <div class="mobile-nav-title">System</div>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/profile')">
                    <i class="fas fa-user-circle"></i>
                    <span>Account</span>
                </a>
                <a href="#" class="mobile-nav-link" onclick="navigateTo('/generate')">
                    <i class="fas fa-cog"></i>
                    <span>Manage Access</span>
                </a>
                <a href="#" class="mobile-nav-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="mobile-content" id="mainContent">
        <div class="content-header">
            <h1 class="content-title">Dashboard</h1>
            <div class="date-display">
                <i class="fas fa-calendar-day"></i>
                <span id="currentDate"></span>
            </div>
        </div>
        
        <!-- Stats Widgets -->
        <div class="mobile-dashboard">
            <div class="mobile-widget">
                <div class="widget-header">
                    <h3 class="widget-title">On Shift Today</h3>
                    <i class="fas fa-users" style="color: var(--secondary-color);"></i>
                </div>
                <div class="widget-value" id="employees">--</div>
                <div class="widget-footer">
                    <span>Employees</span>
                </div>
            </div>
            
            <div class="mobile-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Pending Rota Approvals</h3>
                    <i class="fas fa-clock" style="color: #ff9800;"></i>
                </div>
                <div class="widget-value" id="approve">--</div>
                <div class="widget-footer">
                    <span>Confirmations waiting</span>
                    <a href="#" onclick="navigateTo('/confirmrota')" style="color: var(--secondary-color);">Review</a>
                </div>
            </div>

            <div class="mobile-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Pending Tips Approvals</h3>
                    <i class="fas fa-clock" style="color: #29bce0;"></i>
                </div>
                <div class="widget-value" id="tip">--</div>
                <div class="widget-footer">
                    <span>Confirmations waiting</span>
                    <a href="#" onclick="navigateTo('/tip')" style="color: var(--secondary-color);">Review</a>
                </div>
            </div>
            
            <div class="mobile-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Labor Cost</h3>
                    <i class="fas fa-pound-sign" style="color: #f44336;"></i>
                </div>
                <div class="widget-value" id="labor">--</div>
                <div class="widget-footer">
                    <span>This Week</span>
                    <a href="#" onclick="navigateTo('/labor')" style="color: var(--secondary-color);">Details</a>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <h2 class="quick-actions-title">Quick Actions</h2>
        <div class="mobile-actions">
            <a href="#" class="mobile-action" onclick="navigateTo('/confirmrota')">
                <div class="action-icon">
                    <i class="fas fa-check-double"></i>
                </div>
                <div class="action-label">Approve Rota</div>
            </a>
            
            <a href="#" class="mobile-action" onclick="navigateTo('/endday')">
                <div class="action-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="action-label">End of Day</div>
            </a>
            
            <a href="#" class="mobile-action" onclick="navigateTo('/tip')">
                <div class="action-icon">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
                <div class="action-label">Daily Tips</div>
            </a>
            
            <a href="#" class="mobile-action" onclick="navigateTo('/userholidays')">
                <div class="action-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="action-label">Holiday Booking</div>
            </a>
        </div>
        
        <!-- Recent Activity -->
        <h2 style="margin: 1.5rem 0 1rem; color: var(--primary-color);">Today's Shifts</h2>
        <div class="mobile-table-container">
            <table class="mobile-table">
                <thead>
                    <tr>                                   
                        <th>Employee</th>                                    
                        <th>Designation</th>
                        <th>Shift</th>
                        <th>Activity</th>
                    </tr>
                </thead>
                <tbody id="shiftsTableBody">
                    <tr>
                        <td colspan="4" class="loading-state">Loading shifts...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="mobile-footer">
        <p>Solura Workforce Management System &copy; 2024</p>
    </footer>
    
    <!-- Reports Modal -->
    <div class="mobile-modal" id="reportsModalMobile">
        <div class="mobile-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Available Reports</h3>
                <button class="close-modal" id="closeReportsModalMobile">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Report Item 1 -->
                <div class="report-item">
                    <div class="report-info">
                        <div class="report-name">Payroll Report</div>
                        <div class="report-desc">Comprehensive Payroll Overview</div>
                    </div>
                    <a href="#" onclick="navigateTo('/hours')" class="report-button">Open</a>
                </div>
                
                <!-- Report Item 2 -->
                <div class="report-item">
                    <div class="report-info">
                        <div class="report-name">Weekly Labor Cost Report</div>
                        <div class="report-desc">Weekly Performance Metrics</div>
                    </div>
                    <a href="#" onclick="navigateTo('/labor')" class="report-button">Open</a>
                </div>
                
                <!-- Report Item 3 -->
                <div class="report-item">
                    <div class="report-info">
                        <div class="report-name">Financial Summary</div>
                        <div class="report-desc">Revenue & Cost Overview</div>
                    </div>
                    <a href="#" onclick="navigateTo('/financialsummary')" class="report-button">Open</a>
                </div>
            </div>
        </div>
    </div>
<script>
    // Global variables
    let currentUser = null;
    let inactivityTimer;
    let sessionId = null;
    let accessToken = null;
    let isIOSApp = false;
    let isIPadDevice = false;
    let availableDatabases = [];
    let sessionInitialized = false;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('Mobile App: Initializing...');
        
        // Enhanced iOS and iPad detection
        isIOSApp = window.navigator.standalone || 
                (window.matchMedia('(display-mode: standalone)').matches) ||
                (navigator.userAgent.includes('iPhone') && !navigator.userAgent.includes('Safari')) ||
                (navigator.userAgent.includes('iPad') && !navigator.userAgent.includes('Safari'));
        
        isIPadDevice = /iPad/.test(navigator.userAgent) || 
                      (/Macintosh/.test(navigator.userAgent) && /AppleWebKit/.test(navigator.userAgent) && !/Safari/.test(navigator.userAgent));

        console.log('ðŸ“± Device Detection:', {
            isIOSApp: isIOSApp,
            isIPadDevice: isIPadDevice,
            userAgent: navigator.userAgent
        });
        
        // Get session data from multiple sources
        const urlParams = new URLSearchParams(window.location.search);
        sessionId = urlParams.get('sessionId') || localStorage.getItem('sessionId');
        accessToken = localStorage.getItem('accessToken');
        
        // CRITICAL: Initialize iPad session first
        if (isIPadDevice) {
            console.log('ðŸ“± iPad Device - Initializing iPad-specific session');
            await initializeIPadSession();
        } else if (isIOSApp) {
            console.log('ðŸ“± iOS App - Initializing session first');
            await initializeIOSSession();
        } else {
            // Regular browsers use standard authentication
            const hasValidSession = await checkInitialAuthentication();
            if (!hasValidSession) {
                console.log('âŒ No valid session found, redirecting to login');
                redirectToLogin();
                return;
            }
        }
        
        // Setup UI components
        initializeUI();
        
        // Validate session and load data
        await initializeSession();
    });

    // Enhanced iPad session initialization
    async function initializeIPadSession() {
        console.log('ðŸ“± iPad-specific session initialization...');
        
        // Check URL parameters first (this is CRITICAL for database switch)
        const urlParams = new URLSearchParams(window.location.search);
        const sessionIdFromUrl = urlParams.get('sessionId');
        const name = urlParams.get('name');
        const lastName = urlParams.get('lastName');
        const email = urlParams.get('email');
        const dbName = urlParams.get('dbName');
        
        // If we have a session ID from URL (from database switch), use it
        if (sessionIdFromUrl) {
            console.log('ðŸ“± iPad: Found session ID in URL parameters:', sessionIdFromUrl);
            sessionId = sessionIdFromUrl;
            localStorage.setItem('sessionId', sessionIdFromUrl);
        }
        
        if (name && lastName && email && dbName) {
            console.log('ðŸ“± iPad: Found user data in URL parameters');
            currentUser = {
                email: email,
                name: name,
                lastName: lastName,
                dbName: dbName
            };
            localStorage.setItem('userInfo', JSON.stringify(currentUser));
            localStorage.setItem('lastDb', dbName);
            sessionInitialized = true;
            return;
        }
        
        // Method 2: Check localStorage
        const storedUser = localStorage.getItem('userInfo');
        if (storedUser) {
            console.log('ðŸ“± iPad: Found stored user data');
            currentUser = JSON.parse(storedUser);
            sessionInitialized = true;
            return;
        }
        
        // Method 3: Try to initialize session with server using iPad-specific endpoint
        console.log('ðŸ“± iPad: No immediate user data, initializing session with server...');
        await initializeIPadSessionWithServer();
    }
    
    // Initialize iPad session with server
    async function initializeIPadSessionWithServer() {
        try {
            console.log('ðŸ“± iPad: Initializing session with server...');
            
            // First, try iPad-specific initialization
            const initResponse = await fetch('/api/ipad-init', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'X-Device-Type': 'ipad'
                }
            });
            
            if (initResponse.ok) {
                const initData = await initResponse.json();
                console.log('âœ… iPad session initialized:', initData);
                
                // Update session ID if provided
                if (initData.sessionId) {
                    sessionId = initData.sessionId;
                    localStorage.setItem('sessionId', initData.sessionId);
                }
                
                sessionInitialized = true;
                
                // Now try to get current user
                const userResponse = await fetch('/api/current-user', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache',
                        'X-Session-ID': sessionId || '',
                        'X-Device-Type': 'ipad'
                    }
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    if (userData.success && userData.user) {
                        console.log('âœ… iPad user session found');
                        currentUser = userData.user;
                        localStorage.setItem('userInfo', JSON.stringify(userData.user));
                        return;
                    }
                }
            } else {
                console.log('âŒ Failed to initialize iPad session, trying regular method');
                await initializeSessionWithServer();
            }
            
        } catch (error) {
            console.error('ðŸš¨ Error initializing iPad session with server:', error);
            // Fallback to regular session initialization
            await initializeSessionWithServer();
        }
    }
    
    // Enhanced iOS session initialization
    async function initializeIOSSession() {
        console.log('ðŸ“± iOS App session initialization...');
        
        // Check URL parameters first (this is CRITICAL for database switch)
        const urlParams = new URLSearchParams(window.location.search);
        const sessionIdFromUrl = urlParams.get('sessionId');
        const name = urlParams.get('name');
        const lastName = urlParams.get('lastName');
        const email = urlParams.get('email');
        const dbName = urlParams.get('dbName');
        
        // If we have a session ID from URL (from database switch), use it
        if (sessionIdFromUrl) {
            console.log('ðŸ“± Found session ID in URL parameters:', sessionIdFromUrl);
            sessionId = sessionIdFromUrl;
            localStorage.setItem('sessionId', sessionIdFromUrl);
        }
        
        if (name && lastName && email && dbName) {
            console.log('ðŸ“± Found user data in URL parameters');
            currentUser = {
                email: email,
                name: name,
                lastName: lastName,
                dbName: dbName
            };
            localStorage.setItem('userInfo', JSON.stringify(currentUser));
            localStorage.setItem('lastDb', dbName);
            sessionInitialized = true;
            return;
        }
        
        // Method 2: Check localStorage
        const storedUser = localStorage.getItem('userInfo');
        if (storedUser) {
            console.log('ðŸ“± Found stored user data');
            currentUser = JSON.parse(storedUser);
            sessionInitialized = true;
            return;
        }
        
        // Method 3: Try to initialize session with server
        console.log('ðŸ“± No immediate user data, initializing session with server...');
        await initializeSessionWithServer();
    }
    
    // Initialize session with server for iOS
    async function initializeSessionWithServer() {
        try {
            console.log('ðŸ“± Initializing session with server...');
            
            // First, try to get current session
            const response = await fetch('/api/current-user', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache',
                    'X-Session-ID': sessionId || ''
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.user) {
                    console.log('âœ… Server session found');
                    currentUser = data.user;
                    localStorage.setItem('userInfo', JSON.stringify(data.user));
                    sessionInitialized = true;
                    return;
                }
            }
            
            // If no session, try to initialize one
            console.log('ðŸ“± No existing session, creating new one...');
            const initResponse = await fetch('/api/ios-init', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (initResponse.ok) {
                const initData = await initResponse.json();
                console.log('âœ… iOS session initialized:', initData);
                
                // Update session ID if provided
                if (initData.sessionId) {
                    sessionId = initData.sessionId;
                    localStorage.setItem('sessionId', initData.sessionId);
                }
                
                sessionInitialized = true;
            } else {
                console.log('âŒ Failed to initialize iOS session');
            }
            
        } catch (error) {
            console.error('ðŸš¨ Error initializing session with server:', error);
        }
    }

    // Check initial authentication
    async function checkInitialAuthentication() {
        console.log('ðŸ” Checking initial authentication...');
        
        try {
            const response = await fetch('/api/current-user', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.user) {
                    console.log('âœ… Initial authentication successful');
                    currentUser = data.user;
                    return true;
                }
            }
        } catch (error) {
            console.log('âŒ Initial authentication failed:', error);
        }
        
        return false;
    }

    // Initialize UI components
    function initializeUI() {
        console.log('Initializing UI components...');
        
        // Setup mobile menu
        const menuToggle = document.getElementById('menuToggle');
        const closeMenu = document.getElementById('closeMenu');
        const mobileMenu = document.getElementById('mobileMenu');
        const menuOverlay = document.getElementById('menuOverlay');

        if (menuToggle && mobileMenu) {
            menuToggle.addEventListener('click', function() {
                mobileMenu.classList.add('active');
                menuOverlay.classList.add('active');
            });
        }

        if (closeMenu && mobileMenu) {
            closeMenu.addEventListener('click', function() {
                mobileMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
            });
        }

        if (menuOverlay) {
            menuOverlay.addEventListener('click', function() {
                mobileMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
            });
        }

        // Setup reports modal
        const reportsLink = document.getElementById('reportsLinkMobile');
        const reportsModal = document.getElementById('reportsModalMobile');
        const closeReportsModal = document.getElementById('closeReportsModalMobile');

        if (reportsLink && reportsModal) {
            reportsLink.addEventListener('click', function(e) {
                e.preventDefault();
                reportsModal.style.display = 'flex';
            });
        }

        if (closeReportsModal && reportsModal) {
            closeReportsModal.addEventListener('click', function() {
                reportsModal.style.display = 'none';
            });
        }

        if (reportsModal) {
            reportsModal.addEventListener('click', function(e) {
                if (e.target === reportsModal) {
                    reportsModal.style.display = 'none';
                }
            });
        }

        // Update date display
        updateLiveDateTime();
        setInterval(updateLiveDateTime, 1000);
        
        // Initialize database switcher
        initializeDatabaseSwitcher();
    }

    // Initialize database switcher
    async function initializeDatabaseSwitcher() {
        const dbSwitcher = document.getElementById('databaseSwitcher');
        if (!dbSwitcher) return;
        
        try {
            const response = await fetchWithRecovery('/api/user-databases');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    availableDatabases = data.databases;
                    populateDatabaseSwitcher(data.databases, data.currentDb);
                    
                    // For iOS/iPad: Add change event listener
                    const dbSelect = document.getElementById('databaseSelect');
                    if (dbSelect && (isIOSApp || isIPadDevice)) {
                        dbSelect.addEventListener('change', function(e) {
                            if (e.target.value && e.target.value !== currentUser?.dbName) {
                                switchDatabase(e.target.value);
                            }
                        });
                    }
                }
            }
        } catch (error) {
            console.error('Error loading databases:', error);
        }
    }
        
    // Populate database switcher dropdown
    function populateDatabaseSwitcher(databases, currentDb) {
        const dbSelect = document.getElementById('databaseSelect');
        if (!dbSelect) return;
        
        dbSelect.innerHTML = '';
        
        databases.forEach(db => {
            const option = document.createElement('option');
            option.value = db.db_name;
            option.textContent = db.db_name;
            option.selected = db.db_name === currentDb;
            dbSelect.appendChild(option);
        });
        
        console.log('âœ… Database switcher populated with', databases.length, 'databases');
    }

    // FIXED: Database switch function for iPad and iOS
    async function switchDatabase(newDbName) {
        if (!newDbName || !currentUser) return;
        
        try {
            console.log('ðŸ”„ Switching to database:', newDbName);
            
            const response = await fetchWithRecovery('/api/switch-database', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-Device-Type': isIPadDevice ? 'ipad' : (isIOSApp ? 'ios' : 'web')
                },
                credentials: 'include',
                body: JSON.stringify({ 
                    dbName: newDbName,
                    email: currentUser.email 
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log('âœ… Database switched successfully');
                
                // CRITICAL: Update currentUser and session ID
                currentUser = data.user;
                sessionId = data.sessionId; // Update the session ID
                localStorage.setItem('userInfo', JSON.stringify(data.user));
                localStorage.setItem('sessionId', data.sessionId);
                
                console.log('ðŸ†• New session ID:', data.sessionId);
                
                // For iPad/iOS: Use the NEW session ID in the reload
                if (isIPadDevice || isIOSApp) {
                    console.log('ðŸ“± iPad/iOS App - Reloading with new session ID');
                    // Use the NEW session ID in the URL
                    const newUrl = `${window.location.pathname}?sessionId=${encodeURIComponent(data.sessionId)}&t=${Date.now()}`;
                    setTimeout(() => {
                        window.location.replace(newUrl);
                    }, 500);
                } else {
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
                
            } else {
                throw new Error(data.error || 'Failed to switch database');
            }
            
        } catch (error) {
            console.error('âŒ Error switching database:', error);
            showNotification('Error switching database', 'error');
            
            // Reset the dropdown to current database
            const dbSelect = document.getElementById('databaseSelect');
            if (dbSelect && currentUser) {
                dbSelect.value = currentUser.dbName;
            }
        }
    }
        
    // Show notification
    function showNotification(message, type = 'info') {
        let notification = document.getElementById('globalNotification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'globalNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
            `;
            document.body.appendChild(notification);
        }
        
        const styles = {
            success: 'background: #4CAF50;',
            error: 'background: #f44336;',
            info: 'background: #2196F3;'
        };
        
        notification.style.cssText += styles[type] || styles.info;
        notification.textContent = message;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // Session initialization
    async function initializeSession() {
        console.log('Mobile App: Checking session...');
        
        // For iPad Devices, use enhanced session validation
        if (isIPadDevice) {
            console.log('ðŸ“± Using iPad-specific session validation');
            const isValid = await validateIPadSession();
            if (!isValid) {
                showSessionError();
                return;
            }
        } else if (isIOSApp) {
            // For iOS Apps, use iOS-specific validation
            console.log('ðŸ“± Using iOS App session validation');
            const isValid = await validateIOSSession();
            if (!isValid) {
                showSessionError();
                return;
            }
        } else {
            // Regular session validation for Safari
            const isValid = await validateSessionWithRecovery();
            if (!isValid) {
                showSessionError();
                return;
            }
        }
        
        console.log('Session valid, loading dashboard data...');
        loadDashboardData();
    }

    // iPad-specific session validation
    async function validateIPadSession() {
        try {
            console.log('ðŸ“± Validating iPad session...');
            
            // Method 1: Try with current user data
            if (currentUser && sessionInitialized) {
                console.log('âœ… iPad: Using existing session data');
                return true;
            }
            
            // Method 2: Try iPad-specific session validation
            const validationResponse = await fetch('/api/ipad-validate', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'X-Device-Type': 'ipad',
                    'X-Session-ID': sessionId || ''
                }
            });
            
            if (validationResponse.ok) {
                const validationData = await validationResponse.json();
                if (validationData.valid && validationData.user) {
                    console.log('âœ… iPad session validation successful');
                    currentUser = validationData.user;
                    sessionId = validationData.sessionId;
                    localStorage.setItem('userInfo', JSON.stringify(validationData.user));
                    localStorage.setItem('sessionId', validationData.sessionId);
                    return true;
                }
            }
            
            // Method 3: Try session restoration
            const restored = await restoreIPadSession();
            if (restored) {
                return true;
            }
            
            // Method 4: Try session recovery
            return await attemptSessionRecovery();
            
        } catch (error) {
            console.error('ðŸš¨ iPad session validation error:', error);
            return await attemptSessionRecovery();
        }
    }

    // iPad-specific session restoration
    async function restoreIPadSession() {
        try {
            const storedUser = localStorage.getItem('userInfo');
            const lastDb = localStorage.getItem('lastDb');
            
            if (!storedUser) return false;
            
            const userInfo = JSON.parse(storedUser);
            const restorationData = {
                email: userInfo.email,
                dbName: userInfo.dbName || lastDb,
                accessToken: accessToken
            };
            
            console.log('ðŸ“± iPad restoration data:', restorationData);
            
            const response = await fetch('/api/ios-restore-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-Session-ID': sessionId || '',
                    'X-Device-Type': 'ipad',
                    'Authorization': accessToken ? `Bearer ${accessToken}` : ''
                },
                credentials: 'include',
                body: JSON.stringify(restorationData)
            });
            
            console.log('ðŸ“± iPad restoration response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('âœ… iPad session restored successfully');
                
                currentUser = data.user;
                if (data.sessionId) {
                    sessionId = data.sessionId;
                    localStorage.setItem('sessionId', data.sessionId);
                }
                if (data.accessToken) {
                    accessToken = data.accessToken;
                    localStorage.setItem('accessToken', data.accessToken);
                }
                localStorage.setItem('userInfo', JSON.stringify(data.user));
                sessionInitialized = true;
                
                return true;
            }
            return false;
        } catch (error) {
            console.error('ðŸš¨ iPad session restoration error:', error);
            return false;
        }
    }

    // iOS App specific session validation
    async function validateIOSSession() {
        try {
            console.log('ðŸ“± Validating iOS App session...');
            
            // Method 1: Try with current user data
            if (currentUser && sessionInitialized) {
                console.log('âœ… Using existing session data');
                return true;
            }
            
            // Method 2: Try session restoration
            const restored = await restoreIOSSession();
            if (restored) {
                return true;
            }
            
            // Method 3: Try session recovery
            return await attemptSessionRecovery();
            
        } catch (error) {
            console.error('ðŸš¨ iOS App session validation error:', error);
            return await attemptSessionRecovery();
        }
    }

    // iOS-specific session restoration
    async function restoreIOSSession() {
        try {
            const storedUser = localStorage.getItem('userInfo');
            const lastDb = localStorage.getItem('lastDb');
            
            if (!storedUser) return false;
            
            const userInfo = JSON.parse(storedUser);
            const restorationData = {
                email: userInfo.email,
                dbName: userInfo.dbName || lastDb,
                accessToken: accessToken
            };
            
            console.log('ðŸ“± iOS App restoration data:', restorationData);
            
            const response = await fetch('/api/ios-restore-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-Session-ID': sessionId || '',
                    'Authorization': accessToken ? `Bearer ${accessToken}` : ''
                },
                credentials: 'include',
                body: JSON.stringify(restorationData)
            });
            
            console.log('ðŸ“± iOS App restoration response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('âœ… iOS App session restored successfully');
                
                currentUser = data.user;
                if (data.sessionId) {
                    sessionId = data.sessionId;
                    localStorage.setItem('sessionId', data.sessionId);
                }
                if (data.accessToken) {
                    accessToken = data.accessToken;
                    localStorage.setItem('accessToken', data.accessToken);
                }
                localStorage.setItem('userInfo', JSON.stringify(data.user));
                sessionInitialized = true;
                
                return true;
            }
            return false;
        } catch (error) {
            console.error('ðŸš¨ iOS App session restoration error:', error);
            return false;
        }
    }

    // Enhanced session validation for regular browsers
    async function validateSessionWithRecovery() {
        try {
            console.log('ðŸ” Validating session...');
            
            const response = await fetchWithRecovery('/api/validate-session');
            
            console.log('Session validation response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.valid && data.user) {
                    console.log('âœ… Session valid, user:', data.user.email);
                    currentUser = data.user;
                    updateStoredUserData(data.user, data.sessionId);
                    return true;
                } else {
                    console.log('âŒ Session invalid or user data missing');
                    return await attemptSessionRecovery();
                }
            } else if (response.status === 401) {
                console.log('ðŸ”„ Session expired, attempting recovery...');
                return await attemptSessionRecovery();
            } else {
                console.log('âŒ Session validation failed with status:', response.status);
                return await attemptSessionRecovery();
            }
            
        } catch (error) {
            console.error('ðŸš¨ Session validation error:', error);
            return await attemptSessionRecovery();
        }
    }

    // Update stored user data
    function updateStoredUserData(user, newSessionId) {
        localStorage.setItem('userInfo', JSON.stringify(user));
        if (user.dbName) {
            localStorage.setItem('lastDb', user.dbName);
        }
        if (newSessionId) {
            sessionId = newSessionId;
            localStorage.setItem('sessionId', newSessionId);
        }
        sessionInitialized = true;
    }

    // Enhanced session recovery for all platforms
    async function attemptSessionRecovery() {
        console.log('ðŸ”„ Attempting session recovery...');
        
        // Try with stored user info
        const storedUser = localStorage.getItem('userInfo');
        const lastDb = localStorage.getItem('lastDb');
        
        if (storedUser) {
            console.log('Found stored user info, attempting recovery...');
            const userInfo = JSON.parse(storedUser);
            
            // Use iPad-specific recovery for iPad
            if (isIPadDevice) {
                return await restoreIPadSession();
            }
            
            // Use iOS-specific recovery for iOS apps
            if (isIOSApp) {
                return await restoreIOSSession();
            }
            
            // Regular recovery for others
            const recoveryData = {
                email: userInfo.email,
                dbName: userInfo.dbName || lastDb,
                sessionId: sessionId
            };
            
            const response = await fetch('/api/recover-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-Session-ID': sessionId || ''
                },
                credentials: 'include',
                body: JSON.stringify(recoveryData)
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('âœ… Session recovered successfully');
                currentUser = data.user;
                updateStoredUserData(data.user, data.sessionId);
                return true;
            }
        }
        
        console.log('âŒ All recovery attempts failed, redirecting to login');
        redirectToLogin();
        return false;
    }

    // Enhanced fetch with session ID management
    async function fetchWithRecovery(url, options = {}) {
        try {
            const config = {
                ...options,
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache',
                    'X-Session-ID': sessionId || '',
                    ...(isIPadDevice && { 'X-Device-Type': 'ipad' }),
                    ...(isIOSApp && !isIPadDevice && { 'X-Device-Type': 'ios' }),
                    ...(accessToken && { 'Authorization': `Bearer ${accessToken}` }),
                    ...options.headers
                }
            };
            
            // iPad/iOS App specific handling with session ID sync
            let targetUrl = url;
            if ((isIPadDevice || isIOSApp) && sessionId) {
                const separator = url.includes('?') ? '&' : '?';
                targetUrl = `${url}${separator}sessionId=${encodeURIComponent(sessionId)}`;
                console.log('ðŸ“± iPad/iOS App fetch URL with session ID:', targetUrl);
            }
            
            console.log(`ðŸ” Fetching: ${targetUrl}`);
            let response = await fetch(targetUrl, config);
            console.log(`ðŸ“¨ Response status: ${response.status} for ${targetUrl}`);
            
            // Check if response contains a new session ID
            const responseSessionId = response.headers.get('X-Session-ID');
            if (responseSessionId && responseSessionId !== sessionId) {
                console.log('ðŸ”„ Updating session ID from response:', responseSessionId);
                sessionId = responseSessionId;
                localStorage.setItem('sessionId', responseSessionId);
            }
            
            // Handle unauthorized responses
            if (response.status === 401) {
                console.log('ðŸ”„ Request unauthorized, attempting recovery...');
                
                let recovered = false;
                if (isIPadDevice) {
                    recovered = await restoreIPadSession();
                } else if (isIOSApp) {
                    recovered = await restoreIOSSession();
                } else {
                    recovered = await attemptSessionRecovery();
                }
                
                if (recovered) {
                    console.log('ðŸ”„ Session recovered, retrying request...');
                    
                    // Update URL with new session ID
                    let retryUrl = url;
                    if ((isIPadDevice || isIOSApp) && sessionId) {
                        const separator = url.includes('?') ? '&' : '?';
                        retryUrl = `${url}${separator}sessionId=${encodeURIComponent(sessionId)}`;
                    }
                    
                    config.headers['X-Session-ID'] = sessionId || '';
                    if (isIPadDevice) config.headers['X-Device-Type'] = 'ipad';
                    if (isIOSApp && !isIPadDevice) config.headers['X-Device-Type'] = 'ios';
                    if (accessToken) {
                        config.headers['Authorization'] = `Bearer ${accessToken}`;
                    }
                    
                    response = await fetch(retryUrl, config);
                    console.log(`ðŸ“¨ Retry response status: ${response.status}`);
                } else {
                    console.log('âŒ Session recovery failed, redirecting to login');
                    redirectToLogin();
                    throw new Error('Unauthorized');
                }
            }
            
            return response;
        } catch (error) {
            console.error(`ðŸš¨ Fetch error for ${url}:`, error);
            
            if (error.message === 'Unauthorized') {
                redirectToLogin();
            }
            
            throw error;
        }
    }   
    
    // SECURE Navigation function
    function navigateTo(url) {
        if (!currentUser && !sessionInitialized) {
            console.log('âŒ No user data available, redirecting to login');
            redirectToLogin();
            return;
        }

        // Build secure URL
        let targetUrl = url.startsWith('/') ? url.substring(1) : url;
        
        const params = new URLSearchParams({
            t: Date.now() // Cache buster only
        });

        // Add session ID for iPad/iOS Apps only if needed
        if ((isIPadDevice || isIOSApp) && sessionId) {
            params.append('sessionId', sessionId);
        }

        const fullUrl = `${targetUrl}?${params.toString()}`;
        console.log(`ðŸ”„ Navigating to: ${targetUrl}`);
        
        // Close mobile menu if open
        const mobileMenu = document.getElementById('mobileMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        if (mobileMenu) mobileMenu.classList.remove('active');
        if (menuOverlay) menuOverlay.classList.remove('active');
        
        window.location.href = fullUrl;
    }

    function showSessionError() {
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.innerHTML = `
                <div class="session-error">
                    <h2>Session Expired</h2>
                    <p>Your session has expired. Please log in again.</p>
                    <button onclick="redirectToLogin()" class="btn-primary">Return to Login</button>
                </div>
            `;
        }
    }

    function redirectToLogin() {
        // Clear all stored data
        localStorage.removeItem('userInfo');
        localStorage.removeItem('lastDb');
        localStorage.removeItem('sessionId');
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        
        // Clear cookies by setting expired date
        document.cookie = "solura.session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        
        window.location.href = '/';
    }

    // Dashboard data loading
    function loadDashboardData() {
        console.log('Loading dashboard data...');
        
        fetchEmployeesOnShift();
        fetchPendingApprovals();
        fetchTipApprovals();
        checkPendingRequests();
        loadLaborCost();
        
        setInterval(fetchEmployeesOnShift, 30000);
        setInterval(fetchPendingApprovals, 60000);
        setInterval(fetchTipApprovals, 60000);
        setInterval(checkPendingRequests, 300000);
        setInterval(() => {
            if (isIPadDevice) {
                validateIPadSession();
            } else if (isIOSApp) {
                validateIOSSession();
            } else {
                validateSessionWithRecovery();
            }
        }, 120000);
        
        setupInactivityTimer();
    }
    
    // Set current date
    function updateLiveDateTime() {
        const now = new Date();
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
            dateElement.textContent = now.toLocaleDateString('en-GB', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(',', '');
        }
    }
    
    // Function to check for pending requests
    function checkPendingRequests() {
        fetchWithRecovery('/request/holidays')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch holidays');
                }
                return response.json();
            })
            .then(data => {
                const pendingRequests = data.filter(request => 
                    !(request.accepted === 'true' || request.accepted === 'unpaid')
                );
                
                const notificationBadge = document.getElementById('holidayNotification');
                if (notificationBadge) {
                    if (pendingRequests.length > 0) {
                        notificationBadge.style.display = 'block';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error checking pending requests:', error);
            });
    }
    
    // Helper to format time
    function formatTimeRange(start, end) {
        const format = (time) => {
            const [h, m] = time.split(':');
            const hour = h % 12 || 12;
            const ampm = h >= 12 ? 'PM' : 'AM';
            return `${hour}:${m} ${ampm}`;
        };
        return `${format(start)} - ${format(end)}`;
    }
    
    // Function to Populate Shift Table
    function populateShiftTable(employees) {
        const tableBody = document.getElementById('shiftsTableBody');
        if (!tableBody) return;
        
        if (!employees || employees.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="loading-state">No employees on shift today</td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = '';

        employees.forEach(employee => {
            const row = document.createElement('tr');
            
            // Employee column
            const nameCell = document.createElement('td');
            nameCell.textContent = employee.employeeName;
            
            // Department column
            const deptCell = document.createElement('td');
            deptCell.textContent = employee.designation;
            deptCell.className = employee.designation === 'BOH' ? 'boh-cell' : 'foh-cell';
            
            // Time Frames column
            const timeCell = document.createElement('td');
            timeCell.innerHTML = employee.timeFrames.map(frame => 
                `<div>${formatTimeRange(frame.start, frame.end)}</div>`
            ).join('');
            
            // Status column
            const statusCell = document.createElement('td');
            statusCell.innerHTML = `
                <div class="status-indicator ${employee.status === 'Working now' ? 'working' : 'inactive'}">
                    ${employee.status}
                </div>
                <small>${employee.nextEvent}</small>
            `;
            
            row.appendChild(nameCell);
            row.appendChild(deptCell);
            row.appendChild(timeCell);
            row.appendChild(statusCell);
            tableBody.appendChild(row);
        });
    }
    
    // Function to update employees on shift widget
    function updateEmployeesOnShift(count) {
        const widgetValue = document.getElementById('employees');
        if (widgetValue) {
            widgetValue.textContent = count;
        }
    }
    
    // Function to update pending approvals count
    function updatePendingApprovals(count) {
        const widget = document.getElementById('approve');
        if (widget) {
            widget.textContent = count;
        }
    }
    
    // Function to fetch pending approvals
    async function fetchPendingApprovals() {
        try {
            const response = await fetchWithRecovery('/api/pending-approvals');
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            
            if (data.success) {
                updatePendingApprovals(data.count);
            } else {
                console.error('Error fetching pending approvals:', data.error);
                updatePendingApprovals('--');
            }
        } catch (error) {
            console.error('Error:', error);
            updatePendingApprovals('--');
        }
    }
    
    // Function to update tip approvals count
    function updateTipApprovals(count) {
        const widget = document.getElementById('tip');
        if (widget) {
            widget.textContent = count;
        }
    }
    
    // Function to fetch tip approvals
    async function fetchTipApprovals() {
        try {
            const response = await fetchWithRecovery('/api/tip-approvals');
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            
            if (data.success) {
                updateTipApprovals(data.count);
            } else {
                console.error('Error fetching Tip approvals:', data.error);
                updateTipApprovals('--');
            }
        } catch (error) {
            console.error('Error:', error);
            updateTipApprovals('--');
        }
    }
    
    // Function to fetch Shift Data
    async function fetchEmployeesOnShift() {
        try {
            const response = await fetchWithRecovery('/api/employees-on-shift');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                updateEmployeesOnShift(data.count);
                populateShiftTable(data.employees);
            } else {
                console.error('Error:', data.error || 'Unknown error');
                updateEmployeesOnShift('--');
                document.getElementById('shiftsTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" class="error-state">Failed to load shifts</td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Fetch error:', error);
            updateEmployeesOnShift('--');
            document.getElementById('shiftsTableBody').innerHTML = `
                <tr>
                    <td colspan="4" class="error-state">Error loading shifts</td>
                </tr>
            `;
        }
    }
    
    // Function for Labor
    function updateLaborCostWidget(cost) {
        const formattedCost = new Intl.NumberFormat('en-GB', {
            style: 'currency',
            currency: 'GBP',
            maximumFractionDigits: 0
        }).format(cost).replace('GBP', '').trim();
        
        const widgetValue = document.getElementById('labor');
        if (widgetValue) {
            widgetValue.textContent = formattedCost;
        }
    }
    
    // Function to load labor cost
    async function loadLaborCost() {
        try {
            const response = await fetchWithRecovery('/api/labor-cost');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            
            if (data.success) {
                updateLaborCostWidget(data.cost);
            } else {
                console.error('Error loading labor cost:', data.error);
                updateLaborCostWidget('--');
            }
        } catch (error) {
            console.error('Error loading labor cost:', error);
            updateLaborCostWidget('--');
        }
    }

    // Logout function
    function logout() {
        fetchWithRecovery('/logout')
            .then(() => {
                redirectToLogin();
            })
            .catch(error => {
                console.error('Logout error:', error);
                redirectToLogin();
            });
    }

    // Inactivity timer
    function setupInactivityTimer() {
        const resetInactivityTimer = () => {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (confirm('You have been inactive for a while. Would you like to stay logged in?')) {
                    resetInactivityTimer();
                } else {
                    logout();
                }
            }, 60 * 60 * 1000);
        };

        // Initialize timer
        resetInactivityTimer();
        
        // Reset on user activity
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        document.addEventListener('touchstart', resetInactivityTimer);
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
    }

    // Global error handler
    window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        if (event.reason && (event.reason.message === 'Unauthorized' || event.reason.status === 401)) {
            console.log('Global auth error caught, redirecting to login');
            redirectToLogin();
        }
    });

    // Export functions for global access
    window.logout = logout;
    window.redirectToLogin = redirectToLogin;
    window.navigateTo = navigateTo;
    window.fetchWithRecovery = fetchWithRecovery;
    window.switchDatabase = switchDatabase;
</script>
</body>
</html>