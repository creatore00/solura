<!DOCTYPE html>
<html lang="en">
<head>
      <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-768D41J8NJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-768D41J8NJ');
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payslips</title>
  <style>
    :root {
      --main-color: #001f3f;
      --light-bg: #ffffff;
      --text-color: #333;
      --highlight: #0074D9;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    nav {
      background-color: var(--main-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }

    nav .logo {
      font-size: 1.5em;
      font-weight: bold;
    }

    nav .menu {
      display: flex;
      gap: 20px;
    }

    nav .menu a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    nav .toggle-switch {
      cursor: pointer;
      background: white;
      color: var(--main-color);
      border-radius: 12px;
      padding: 5px 10px;
      font-size: 0.9em;
    }

    table {
      width: 90%;
      margin: 40px auto;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 15px;
      border: 1px solid #ccc;
      text-align: center;
    }

    th {
      background-color: var(--main-color);
      color: white;
    }

    .btn {
      background-color: var(--main-color);
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .btn:hover {
      background-color: #003366;
    }

    .popup {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      display: none;
    }

    .checkmark {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">Solura</div>
    <div class="menu">
      <a href="#">Employees</a>
      <a href="#">Monthly Report</a>
    </div>
  </nav>

  <h1 style="text-align:center">Upload Payslips</h1>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Last Name</th>
        <th>Email</th>
        <th>Upload Payslip</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="employeesBody"></tbody>
  </table>

  <div class="popup" id="popupMessage">Upload successful!</div>

  <script>

    window.onload = function () {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }

      fetch('/insertpayslip/api/employees')
        .then(response => response.json())
        .then(data => populateEmployees(data))
        .catch(err => console.error('Error fetching employees:', err));
    };

    function populateEmployees(employees) {
      const tableBody = document.getElementById('employeesBody');
      employees.forEach(employee => {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${employee.name}</td>
          <td>${employee.lastName}</td>
          <td>${employee.email}</td>
          <td>
            <form enctype="multipart/form-data">
              <input type="hidden" name="name" value="${employee.name}">
              <input type="hidden" name="lastName" value="${employee.lastName}">
              <input type="hidden" name="email" value="${employee.email}">
              <input type="file" name="payslip" required>
              <button class="btn" type="submit">Upload</button>
            </form>
          </td>
          <td class="status">${employee.lastUpdated ? formatDate(employee.lastUpdated) : 'Never uploaded'}</td>
        `;

        const form = row.querySelector('form');
        form.addEventListener('submit', function (event) {
          event.preventDefault();
          handleUpload(form, row.querySelector('.status'));
        });

        tableBody.appendChild(row);
      });
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function handleUpload(form, statusCell) {
      const formData = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.textContent;
      
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';
      
      fetch('/insertpayslip/api/upload-payslip', {
        method: 'POST',
        body: formData
      })
        .then(res => {
          if (!res.ok) throw new Error('Upload failed');
          return res.json();
        })
        .then(data => {
          statusCell.innerHTML = formatDate(new Date()) + ' <span class="checkmark">&#10004;</span>';
          showPopup('Upload successful!');
        })
        .catch(err => {
          statusCell.innerHTML = '<span style="color:red">Failed</span>';
          showPopup('Upload failed', true);
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;
        });
    }

    function showPopup(message, error = false) {
      const popup = document.getElementById('popupMessage');
      popup.textContent = message;
      popup.style.backgroundColor = error ? 'red' : '#4CAF50';
      popup.style.display = 'block';
      setTimeout(() => popup.style.display = 'none', 3000);
    }

    function downloadPayslip(employeeId) {
        fetch(`/api/download-payslip/${employeeId}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `payslip_${employeeId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showPopup('Payslip downloaded successfully');
            })
            .catch(error => {
                console.error('Error fetching payslip:', error);
                showPopup('Error downloading payslip', true);
            });
    }
</script>
</body>
</html>