<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="icon" href="Front.ico" type="image/png">
<title>Enterprise Login | Data Management Suite</title>
<style>
:root {
    --primary-color: #001f3f;
    --secondary-color: #003366;
    --accent-color: #0074D9;
    --light-text: #777;
    --background-color: #ffffff;
    --input-bg: #f8f9fa;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;
    height:100vh; overflow:hidden; background-color:var(--background-color);
    display:flex; flex-direction:column; padding:0; width:100%; height:100%;
}
.login-container { padding:2rem 1.5rem; width:100%; height:100%; text-align:center; display:flex; flex-direction:column; justify-content:center; position:relative; overflow-y:auto; }
.login-header { margin-bottom:2rem; }
.logo { width:80px; height:80px; margin:0 auto 1.5rem; background-color:var(--primary-color); border-radius:20px; display:flex; align-items:center; justify-content:center; color:white; font-size:32px; font-weight:bold; }
.login-container h2 { color:var(--primary-color); font-size:24px; margin-bottom:0.5rem; font-weight:600; }
.login-container p { color:var(--light-text); margin-bottom:2rem; font-size:14px; line-height:1.5; padding:0 1rem; }
.login-form { width:100%; margin:0 auto; display:block; }
.form-group { margin-bottom:1.5rem; text-align:left; }
.form-group label { display:block; font-weight:500; margin-bottom:0.5rem; color:var(--primary-color); font-size:14px; text-transform:uppercase; letter-spacing:0.5px; }
.form-group input { width:100%; padding:16px; border:1px solid #ddd; border-radius:8px; font-size:16px; background-color:var(--input-bg); }
.form-group input:focus { border-color:var(--accent-color); outline:none; box-shadow:0 0 0 3px rgba(0,116,217,0.1); }
.form-group button { background-color:var(--primary-color); color:white; padding:16px; border:none; border-radius:8px; cursor:pointer; width:100%; font-size:16px; font-weight:500; margin-top:0.5rem; letter-spacing:0.5px; }
.form-group button:hover { background-color:var(--secondary-color); }
#biometricBtn { display:none; margin-top:1rem; background-color:#28a745; }
#biometricBtn:hover { background-color:#218838; }
.powered-by { margin-top:2rem; font-size:12px; color:var(--light-text); padding:0 1rem; }
</style>
</head>
<body>

<div class="login-container">
    <div class="login-header">
        <div class="logo">EDM</div>
        <h2>Welcome Back</h2>
        <p>Sign in to access your Enterprise Data Management Suite.</p>
    </div>
    <form class="login-form" id="loginForm">
        <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" name="email" required placeholder="your.email@company.com" autocomplete="email">
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required placeholder="••••••••" autocomplete="current-password">
        </div>
        <div class="form-group">
            <button type="submit">Sign In</button>
        </div>
    </form>
    <button id="biometricBtn" onclick="loginWithBiometric()">Login with Face ID / Fingerprint</button>
    <a href="/ForgotPassword" id="forgotPasswordForm">Forgot your password?</a>
    <div class="powered-by">Enterprise Data Management Suite v3.2 · Secure Login</div>
</div>

<script type="module">
import { NativeBiometric } from "capacitor-native-biometric";

// Login standard
async function login(event) {
    event.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    try {
        const response = await fetch('/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        if (data.message) return alert(data.message);

        if (data.accessToken && data.refreshToken) {
            await NativeBiometric.setCredentials({
                server: 'http://localhost:8080',
                username: email,
                password: JSON.stringify({ accessToken: data.accessToken, refreshToken: data.refreshToken })
            });
        }

        if (data.redirectUrl) window.location.href = data.redirectUrl;

    } catch (err) {
        console.error('Errore login:', err);
        alert('Si è verificato un errore. Riprova.');
    }
}

// Login biometrico
async function loginWithBiometric() {
    try {
        const available = await NativeBiometric.isAvailable().catch(() => ({ isAvailable:false }));
        if (!available.isAvailable) return alert('Biometria non disponibile.');

        const credentials = await NativeBiometric.getCredentials({ server: 'http://localhost:8080' }).catch(() => null);
        if (!credentials) return alert('Nessuna credenziale biometrica trovata.');

        const { accessToken, refreshToken } = JSON.parse(credentials.password);

        const verifyResponse = await fetch('/verify-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${accessToken}`
            },
            credentials: 'include'
        });
        const verifyData = await verifyResponse.json();

        if (verifyData.success) {
            window.location.href = verifyData.redirectUrl;
        } else {
            const refreshResponse = await fetch('/refresh-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ refreshToken })
            });
            const refreshData = await refreshResponse.json();
            if (refreshData.success) {
                await NativeBiometric.setCredentials({
                    server: 'http://localhost:8080',
                    username: credentials.username,
                    password: JSON.stringify({ accessToken: refreshData.accessToken, refreshToken: refreshData.refreshToken })
                });
                window.location.href = refreshData.redirectUrl;
            } else {
                alert('Autenticazione fallita. Inserisci email e password.');
            }
        }
    } catch (err) {
        console.error('Errore login biometrico:', err);
        alert('Login biometrico fallito.');
    }
}

// Event listener form
document.getElementById('loginForm').addEventListener('submit', login);

// Mostra pulsante biometrico solo se disponibile
(async function initBiometric() {
    const available = await NativeBiometric.isAvailable().catch(() => ({ isAvailable:false }));
    if (available.isAvailable) document.getElementById('biometricBtn').style.display = 'block';
})();
</script>

</body>
</html>
