<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="Front.ico" type="image/png">
    <title>Enterprise Login | Data Management Suite</title>
    <style>
        :root {
            --primary-color: #001f3f;
            --secondary-color: #003366;
            --accent-color: #0074D9;
            --light-accent: #7FDBFF;
            --text-color: #333;
            --light-text: #777;
            --background-color: #ffffff;
            --input-bg: #f8f9fa;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: var(--background-color);
            background-image: linear-gradient(135deg, rgba(0,31,63,0.05) 0%, rgba(255,255,255,1) 100%);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            padding: 0;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        .login-container {
            background: var(--background-color);
            padding: 2rem 1.5rem;
            width: 100%;
            height: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow-y: auto;
        }
        .login-header { margin-bottom: 2rem; }
        .logo {
            width: 80px; height: 80px;
            margin: 0 auto 1.5rem;
            background-color: var(--primary-color);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
        .login-container h2 { color: var(--primary-color); font-size: 24px; margin-bottom: 0.5rem; font-weight: 600; }
        .login-container p { color: var(--light-text); margin-bottom: 2rem; font-size: 14px; line-height: 1.5; padding: 0 1rem; }
        .login-form { width: 100%; margin: 0 auto; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--primary-color); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input {
            width: 100%; padding: 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background-color: var(--input-bg);
        }
        .form-group input:focus { border-color: var(--accent-color); outline: none; box-shadow: 0 0 0 3px rgba(0,116,217,0.1); }
        .form-group button {
            background-color: var(--primary-color); color: white; padding: 16px; border: none; border-radius: 8px;
            cursor: pointer; width: 100%; font-size: 16px; font-weight: 500; margin-top: 0.5rem; letter-spacing: 0.5px;
        }
        .form-group button:hover { background-color: var(--secondary-color); }
        .powered-by { margin-top: 2rem; font-size: 12px; color: var(--light-text); padding: 0 1rem; }
        
        /* Biometric prompt */
        #biometricPrompt {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            padding: 1rem;
        }
        .prompt-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .prompt-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 12px 12px 0 0;
        }
        .biometric-icon {
            font-size: 48px;
            margin-bottom: 1rem;
        }
        .prompt-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        .prompt-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        .prompt-buttons button.primary-btn {
            background-color: var(--primary-color);
            color: white;
        }
        .prompt-buttons button.primary-btn:hover {
            background-color: var(--secondary-color);
        }
        .prompt-buttons button.secondary-btn {
            background-color: #f8f9fa;
            color: var(--text-color);
            border: 1px solid #ddd;
        }
        .prompt-buttons button.secondary-btn:hover {
            background-color: #e9ecef;
        }
        
        /* Popup database */
        #databasePopup { display: none; position: fixed; top: 0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); z-index:1000; overflow-y:auto; padding:1rem; }
        .popup-content { background:white; border-radius:12px; padding:1.5rem; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:400px; text-align:center; max-height:80vh; overflow-y:auto; }
        .popup-content::before { content:''; position:absolute; top:0; left:0; width:100%; height:6px; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); border-radius:12px 12px 0 0; }
        #databasePopup h3 { margin-bottom:1rem; font-size:20px; color: var(--primary-color); font-weight:600; }
        #databasePopup p { margin-bottom:1.5rem; font-size:14px; color: var(--light-text); }
        #databaseList { list-style:none; padding:0; margin:0 0 1.5rem 0; text-align:left; max-height:200px; overflow-y:auto; }
        #databaseList li { margin:0.75rem 0; padding:0.75rem; border-radius:8px; border:1px solid #eee; }
        #databaseList input { margin-right:12px; }
        .popup-buttons { display:flex; gap:0.75rem; }
        .popup-buttons button { flex:1; padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:500; }
        .popup-buttons button.primary-btn { background-color: var(--primary-color); color:white; }
        .popup-buttons button.primary-btn:hover { background-color: var(--secondary-color); }
        .popup-buttons button.close-btn { background-color:#f8f9fa; color:var(--text-color); border:1px solid #ddd; }
        .popup-buttons button.close-btn:hover { background-color:#e9ecef; }
        .spinner { display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @supports (-webkit-touch-callout: none) { .login-container { padding:2rem 1.5rem; min-height:-webkit-fill-available; } input, button { font-size:16px !important; } }
    </style>
</head>
<body>
    <!-- Database Popup -->
    <div id="databasePopup">
        <div class="popup-content">
            <h3>Select Account</h3>
            <p>Your account has access to multiple accounts. Please select one to continue.</p>
            <ul id="databaseList"></ul>
            <div class="popup-buttons">
                <button class="primary-btn" onclick="submitDatabase()">Continue</button>
                <button class="close-btn" onclick="closePopup()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Biometric Prompt -->
    <div id="biometricPrompt">
        <div class="prompt-content">
            <div class="biometric-icon">ðŸ”’</div>
            <h3>Enable Biometric Login?</h3>
            <p>Would you like to use Face ID or Touch ID for faster login next time?</p>
            <div class="prompt-buttons">
                <button class="primary-btn" onclick="enableBiometric()">Yes, Enable</button>
                <button class="secondary-btn" onclick="skipBiometric()">Not Now</button>
            </div>
        </div>
    </div>

    <!-- Login Container -->
    <div class="login-container">
        <div class="login-header">
            <div class="logo">EDM</div>
            <h2>Welcome Back</h2>
            <p>Sign in to access your Enterprise Data Management Suite.</p>
        </div>

        <!-- Form manuale -->
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required placeholder="your.email@company.com" autocomplete="email">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
            </div>
            <div class="form-group">
                <button type="submit">Sign In</button>
            </div>
        </form>

        <a href="/ForgotPassword" id="forgotPasswordForm">Forgot your password?</a>
        <div class="powered-by">Enterprise Data Management Suite v3.2 Â· Secure Login</div>
    </div>

    <script>
        // Fallback if Capacitor is not available
        let NativeBiometric = null;
        let isCapacitor = typeof Capacitor !== 'undefined';
        
        // Try to load Capacitor plugin
        if (isCapacitor) {
            import("capacitor-native-biometric")
                .then(module => {
                    NativeBiometric = module.NativeBiometric;
                    console.log("Biometric module loaded");
                })
                .catch(err => {
                    console.warn("Could not load biometric module:", err);
                    isCapacitor = false;
                });
        }

        let databases = [];
        let currentUserData = null;

        // Controlla se la biometria Ã¨ disponibile
        async function checkBiometricAvailability() {
            if (!isCapacitor || !NativeBiometric) return false;
            
            try {
                const available = await NativeBiometric.isAvailable();
                return available.isAvailable;
            } catch (error) {
                console.warn('Biometric authentication not available:', error);
                return false;
            }
        }

        // Prova il login biometrico solo se ci sono credenziali salvate
        async function tryBiometricLogin() {
            if (!isCapacitor || !NativeBiometric) return false;
            
            try {
                // Verifica se ci sono credenziali salvate
                await NativeBiometric.getCredentials({ server: "solura-app" });
                
                // Se ci sono, procedi con la verifica biometrica
                await NativeBiometric.verifyIdentity({
                    reason: "Per accedere all'app",
                    title: "Autenticazione",
                    subtitle: "Usa Face ID o impronta"
                });

                const creds = await NativeBiometric.getCredentials({ server: "solura-app" });
                let { accessToken, refreshToken } = JSON.parse(creds.password);

                // Prova login automatico
                let res = await fetch('/auto-login', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (res.status === 401) {
                    // accessToken scaduto, usa refreshToken
                    const refreshRes = await fetch('/refresh-token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refreshToken })
                    });

                    if (!refreshRes.ok) throw new Error("Refresh token fallito");

                    const data = await refreshRes.json();
                    accessToken = data.accessToken;
                    
                    // Salva nuovo accessToken insieme al refreshToken
                    await NativeBiometric.setCredentials({
                        username: creds.username,
                        password: JSON.stringify({ accessToken, refreshToken }),
                        server: "solura-app"
                    });

                    // Login automatico con nuovo accessToken
                    res = await fetch('/auto-login', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                }

                if (res.ok) {
                    const userData = await res.json();
                    window.location.href = userData.redirectUrl;
                    return true;
                }
            } catch (e) {
                console.warn('Login biometrico fallito:', e);
                // Mostra il form di login manuale
                document.getElementById('loginForm').style.display = 'block';
            }
            return false;
        }

        // --- LOGIN MANUALE ---
        async function submitForm(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const submitBtn = document.querySelector('#loginForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Authenticating...';

            try {
                const res = await fetch('/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                
                if (!res.ok) {
                    throw new Error(`Server returned ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();

                if (data.message === 'Multiple databases found') {
                    databases = data.databases;
                    showDatabasePopup(data.databases);
                } else if (data.message === 'Incorrect email or password') {
                    alert('Incorrect Email or Password.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign In';
                } else if (data.redirectUrl) {
                    // Salva i dati utente per mostrare il prompt biometrico dopo
                    currentUserData = {
                        email: email,
                        accessToken: data.accessToken,
                        refreshToken: data.refreshToken,
                        redirectUrl: data.redirectUrl
                    };
                    
                    // Verifica se la biometria Ã¨ disponibile
                    const biometricAvailable = await checkBiometricAvailability();
                    
                    if (biometricAvailable) {
                        // Mostra il prompt per abilitare la biometria
                        document.getElementById('biometricPrompt').style.display = 'block';
                    } else {
                        // Reindirizza direttamente
                        window.location.href = data.redirectUrl;
                    }
                } else {
                    console.error('Unexpected response:', data);
                    alert('An unexpected error occurred.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign In';
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Connection error. Please check your network and try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sign In';
            }
        }

        // Abilita l'accesso biometrico
        async function enableBiometric() {
            if (!isCapacitor || !NativeBiometric) {
                alert('Biometric features not available');
                window.location.href = currentUserData.redirectUrl;
                return;
            }
            
            try {
                await NativeBiometric.setCredentials({
                    username: currentUserData.email,
                    password: JSON.stringify({
                        accessToken: currentUserData.accessToken,
                        refreshToken: currentUserData.refreshToken
                    }),
                    server: "solura-app"
                });
                
                // Nascondi il prompt e reindirizza
                document.getElementById('biometricPrompt').style.display = 'none';
                window.location.href = currentUserData.redirectUrl;
            } catch (error) {
                console.error('Error saving biometric credentials:', error);
                alert('Failed to enable biometric login. Please try again.');
                window.location.href = currentUserData.redirectUrl;
            }
        }

        // Salta l'abilitazione della biometria
        function skipBiometric() {
            document.getElementById('biometricPrompt').style.display = 'none';
            window.location.href = currentUserData.redirectUrl;
        }

        // --- POPUP DATABASE ---
        function showDatabasePopup(databases) {
            const popup = document.getElementById('databasePopup');
            const databaseList = document.getElementById('databaseList');
            databaseList.innerHTML = '';
            databases.forEach(db => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <input type="radio" name="database" id="db-${db.db_name}" value="${db.db_name}" required>
                    <label for="db-${db.db_name}">
                        <strong>${db.db_name}</strong>
                        <span style="display:block; font-size:0.9em; color:var(--light-text)">${db.access} access</span>
                    </label>
                `;
                databaseList.appendChild(li);
            });
            popup.style.display = 'block';
        }

        async function submitDatabase() {
            const selectedDatabase = document.querySelector('input[name="database"]:checked')?.value;
            if (!selectedDatabase) { alert('Please select a database.'); return; }
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const popupBtn = document.querySelector('#databasePopup button:not(.close-btn)');
            popupBtn.disabled = true; popupBtn.innerHTML = '<span class="spinner"></span> Connecting...';

            try {
                const res = await fetch('/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password, dbName: selectedDatabase })
                });
                
                if (!res.ok) {
                    throw new Error(`Server returned ${res.status}`);
                }
                
                const data = await res.json();

                if (data.redirectUrl) {
                    currentUserData = {
                        email: email,
                        accessToken: data.accessToken,
                        refreshToken: data.refreshToken,
                        redirectUrl: data.redirectUrl
                    };
                    
                    // Mostra il prompt biometrico dopo la selezione del database
                    document.getElementById('databasePopup').style.display = 'none';
                    const biometricAvailable = await checkBiometricAvailability();
                    
                    if (biometricAvailable) {
                        document.getElementById('biometricPrompt').style.display = 'block';
                    } else {
                        window.location.href = data.redirectUrl;
                    }
                } else {
                    alert('Unexpected error from server.');
                }
            } catch (e) {
                console.error(e);
                alert('Connection error. Please try again.');
            } finally {
                popupBtn.disabled = false;
                popupBtn.textContent = 'Continue';
            }
        }

        function closePopup() { 
            document.getElementById('databasePopup').style.display = 'none'; 
            document.getElementById('loginForm').reset(); 
        }

        // Inizializzazione
        document.getElementById('loginForm').addEventListener('submit', submitForm);
        
        // All'avvio, prova il login biometrico solo se ci sono credenziali salvate
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Prima controlla se la biometria Ã¨ disponibile
                const biometricAvailable = await checkBiometricAvailability();
                
                if (biometricAvailable) {
                    // Prova il login biometrico
                    const biometricSuccess = await tryBiometricLogin();
                    
                    // Se il login biometrico fallisce, mostra il form
                    if (!biometricSuccess) {
                        document.getElementById('loginForm').style.display = 'block';
                    }
                } else {
                    // Se la biometria non Ã¨ disponibile, mostra direttamente il form
                    document.getElementById('loginForm').style.display = 'block';
                }
            } catch (error) {
                console.error('Initialization error:', error);
                // In caso di errore, mostra il form
                document.getElementById('loginForm').style.display = 'block';
            }
        });
    </script>
</body>
</html>