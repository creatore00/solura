<!DOCTYPE html>
<html lang="en">
<head>
        <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-768D41J8NJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-768D41J8NJ');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Work Schedule</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            line-height: 1.6;
            padding: 10px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            font-size: 1.4rem;
            padding: 15px 0;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .date-selector {
            margin-bottom: 20px;
        }
        .date-selector label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .date-selector input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            background: white;
        }
        .week-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .nav-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            flex: 1;
            min-height: 50px;
            font-weight: 600;
        }
        .nav-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .current-week-label {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        .week-view {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .day-card {
            border-bottom: 1px solid #ecf0f1;
            padding: 0;
        }
        .day-card:last-child {
            border-bottom: none;
        }
        .day-header {
            background: #34495e;
            color: white;
            padding: 18px 20px;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .current-day .day-header {
            background: #3498db;
        }
        .past-day .day-header {
            background: #7f8c8d;
            opacity: 0.9;
        }
        .future-day .day-header {
            background: #95a5a6;
            opacity: 0.9;
        }
        .day-content {
            padding: 20px;
        }
        .employee-shift {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #3498db;
        }
        .employee-shift:last-child {
            margin-bottom: 0;
        }
        .employee-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .shift-times {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #3498db;
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        .no-shifts {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .today-badge {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .footer {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* Tablet and desktop */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            .container {
                max-width: 800px;
            }
            .week-navigation {
                gap: 15px;
            }
            .nav-btn {
                font-size: 1.1rem;
                padding: 18px;
            }
            .current-week-label {
                font-size: 1.1rem;
                padding: 18px;
            }
            .day-header {
                font-size: 1.2rem;
                padding: 20px 25px;
            }
            .employee-shift {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
            }
            .employee-name {
                margin-bottom: 0;
                font-size: 1.1rem;
            }
            .shift-times {
                min-width: 140px;
                font-size: 1.1rem;
            }
        }
        
        /* Large screens */
        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ My Work Schedule</h1>
        
        <div class="controls">
            <div class="date-selector">
                <label for="daySelect">Select Date:</label>
                <input type="date" id="daySelect">
            </div>
            
            <div class="current-week-label" id="currentWeek"></div>
            
            <div class="week-navigation">
                <button id="prevWeek" class="nav-btn">‚Üê Previous Week</button>
                <button id="nextWeek" class="nav-btn" disabled>Next Week ‚Üí</button>
            </div>
        </div>
        
        <div id="weekView" class="week-view">
            <div class="loading">
                <span class="spinner"></span>Loading schedule...
            </div>
        </div>
        
        <div class="footer">
            <p>Only past and current week schedules are displayed</p>
            <p>Scroll down to see all days</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Get the current date and set maximum to Sunday of current week
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Calculate Sunday of current week
            const currentSunday = new Date(today);
            currentSunday.setDate(today.getDate() + (7 - today.getDay()) % 7);
            
            // Set max attribute for date input to current Sunday
            const daySelect = document.getElementById('daySelect');
            daySelect.max = currentSunday.toISOString().split('T')[0];
            daySelect.value = today.toISOString().split('T')[0];
            
            // Initialize with current week
            let currentDate = new Date(today);
            
            // Load the rota on page load
            loadrota();
            updateWeekNavigation();
            
            // Event listeners
            daySelect.addEventListener('change', function() {
                currentDate = new Date(this.value);
                loadrota();
                updateWeekNavigation();
            });
            
            document.getElementById('prevWeek').addEventListener('click', handlePrevWeek);
            document.getElementById('nextWeek').addEventListener('click', handleNextWeek);

            function handlePrevWeek() {
                currentDate.setDate(currentDate.getDate() - 7);
                daySelect.value = currentDate.toISOString().split('T')[0];
                loadrota();
                updateWeekNavigation();
            }

            function handleNextWeek() {
                const nextWeekDate = new Date(currentDate);
                nextWeekDate.setDate(nextWeekDate.getDate() + 7);
                
                if (nextWeekDate <= currentSunday) {
                    currentDate = nextWeekDate;
                    daySelect.value = currentDate.toISOString().split('T')[0];
                    loadrota();
                    updateWeekNavigation();
                }
            }

            function loadrota() {
                const monday = getMonday(currentDate);
                const sunday = new Date(monday);
                sunday.setDate(sunday.getDate() + 6);
                
                const startDate = formatDateForAPI(monday);
                const endDate = formatDateForAPI(sunday);
                
                // Update current week display
                document.getElementById('currentWeek').textContent = 
                    `Week of ${formatDisplayDate(monday)} to ${formatDisplayDate(sunday)}`;
                
                // Show loading state
                const weekView = document.getElementById('weekView');
                weekView.innerHTML = '<div class="loading"><span class="spinner"></span>Loading schedule...</div>';
                
                // Fetch data from API
                fetch(`/UserCRota/rota?start=${startDate}&end=${endDate}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network error');
                        return response.json();
                    })
                    .then(data => {
                        displayWeekView(data, monday);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        weekView.innerHTML = '<div class="no-shifts">Error loading schedule. Please try again.</div>';
                    });
            }

            function displayWeekView(data, monday) {
                const weekView = document.getElementById('weekView');
                const todayFormatted = formatDate(today);
                const weekDays = getWeekDays(monday);
                
                let html = '';
                
                weekDays.forEach(day => {
                    const dayDate = parseDisplayDate(day);
                    let dayClass = '';
                    let todayBadge = '';
                    
                    if (day === todayFormatted) {
                        dayClass = 'current-day';
                        todayBadge = '<span class="today-badge">TODAY</span>';
                    } else if (dayDate < today) {
                        dayClass = 'past-day';
                    } else if (dayDate > today) {
                        dayClass = 'future-day';
                    }
                    
                    // Get shifts for this day
                    const dayShifts = data.filter(shift => {
                        const shiftDate = parseDisplayDate(shift.day);
                        return shiftDate.getTime() === dayDate.getTime();
                    });
                    
                    html += `
                        <div class="day-card ${dayClass}">
                            <div class="day-header">
                                <span>${day}</span>
                                ${todayBadge}
                            </div>
                            <div class="day-content">
                    `;
                    
                    if (dayShifts.length > 0) {
                        // Group by employee
                        const shiftsByEmployee = groupShiftsByEmployee(dayShifts);
                        
                        Object.keys(shiftsByEmployee).forEach(employeeKey => {
                            const employee = shiftsByEmployee[employeeKey];
                            html += `
                                <div class="employee-shift">
                                    <div class="employee-name">${employee.name} ${employee.lastName}</div>
                                    <div class="shift-times">
                                        ${employee.shifts.map(shift => 
                                            `${shift.startTime.slice(0, 5)} - ${shift.endTime.slice(0, 5)}`
                                        ).join(' & ')}
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<div class="no-shifts">No shifts scheduled</div>';
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                weekView.innerHTML = html;
            }

            function groupShiftsByEmployee(shifts) {
                const grouped = {};
                shifts.forEach(shift => {
                    const key = `${shift.name}-${shift.lastName}`;
                    if (!grouped[key]) {
                        grouped[key] = {
                            name: shift.name,
                            lastName: shift.lastName,
                            shifts: []
                        };
                    }
                    grouped[key].shifts.push({
                        startTime: shift.startTime,
                        endTime: shift.endTime
                    });
                });
                return grouped;
            }

            // Utility functions
            function parseDisplayDate(dateString) {
                const datePart = dateString.split(' ')[0];
                const [day, month, year] = datePart.split('/');
                return new Date(year, month - 1, day);
            }

            function formatDate(date) {
                const day = ('0' + date.getDate()).slice(-2);
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const year = date.getFullYear();
                const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()];
                return `${day}/${month}/${year} (${dayOfWeek})`;
            }

            function formatDisplayDate(date) {
                const day = ('0' + date.getDate()).slice(-2);
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            function formatDateForAPI(date) {
                const day = ('0' + date.getDate()).slice(-2);
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            function getMonday(date) {
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(date.setDate(diff));
            }

            function getWeekDays(monday) {
                const weekDays = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(monday);
                    date.setDate(date.getDate() + i);
                    weekDays.push(formatDate(date));
                }
                return weekDays;
            }

            function updateWeekNavigation() {
                const nextWeekDate = new Date(currentDate);
                nextWeekDate.setDate(nextWeekDate.getDate() + 7);
                document.getElementById('nextWeek').disabled = nextWeekDate > currentSunday;
            }
        }
    </script>
</body>
</html>