<!DOCTYPE html>
<html lang="en">
<head>
        <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-768D41J8NJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-768D41J8NJ');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Rota Management System</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --light-gray: #ecf0f1;
            --medium-gray: #bdc3c7;
            --dark-gray: #7f8c8d;
            --white: #ffffff;
            --black: #2c3e50;
            --boh-color: #fff9c4;
            --foh-color: #bbdefb;
            --manager-color: #ffcdd2;
            --supervisor-color: #ffccbc;
            --holiday-color: #c8e6c9;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: var(--black);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }

        .container {
            max-width: 3000px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: var(--secondary-color);
            margin-bottom: 30px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .week-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-picker {
            padding: 10px 15px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
            background-color: var(--white);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .date-picker:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--white);
        }

        .btn-secondary:hover {
            background-color: #1a252f;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: var(--white);
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: var(--white);
        }

        .btn-success:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }

        .table-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow-x: auto;
            margin-bottom: 30px;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1200px;
        }

        th, td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #e0e0e0;
            vertical-align: middle;
        }

        th {
            background-color: var(--secondary-color);
            color: var(--white);
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr {
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .day-cell {
            min-width: 150px;
        }

        .time-input {
            width: 100px;
            padding: 8px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
            transition: var(--transition);
            margin: 2px 0;
        }

        .time-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            margin: 4px 2px;
            text-transform: uppercase;
        }

        .btn-swap {
            background-color: var(--info-color);
            color: var(--white);
        }

        .btn-swap:hover {
            background-color: #2980b9;
        }

        .btn-off {
            background-color: var(--danger-color);
            color: var(--white);
        }

        .btn-off:hover {
            background-color: #c0392b;
        }

        .hidden-cell {
            color: transparent;
            text-shadow: none;
            user-select: none;
            pointer-events: none;
        }

        /* Row coloring based on designation */
        .boh-row {
            background-color: var(--boh-color);
        }

        .foh-row {
            background-color: var(--foh-color);
        }

        .manager-cell {
            background-color: var(--manager-color);
        }

        .supervisor-cell {
            background-color: var(--supervisor-color);
        }

        .holiday-cell {
            background-color: var(--holiday-color);
        }

        /* Footer styles */
        tfoot td {
            font-weight: 500;
            background-color: var(--light-gray);
        }

        .total-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .summary-row td {
            text-align: right;
            padding-right: 20px;
        }

        .summary-input {
            width: 70px;
            padding: 6px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            text-align: center;
            margin-left: 5px;
        }

        /* Popup message */
        .popup-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: var(--white);
            padding: 12px 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .popup-message.show {
            opacity: 1;
        }

        /* Time frame input panel */
        .time-frame-panel {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            width: 350px;
        }

        .time-frame-panel.show {
            display: block;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--secondary-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--dark-gray);
        }

        .time-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .time-input-group label {
            width: 80px;
            font-weight: 500;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .header-section {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .week-navigation {
                width: 100%;
                justify-content: space-between;
            }
            
            .button-group {
                width: 100%;
                justify-content: flex-end;
            }
        }

        @media (max-width: 768px) {
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .time-input {
                width: 70px;
                font-size: 13px;
            }
        }

        /* Animation for table rows */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        tbody tr {
            animation: fadeInUp 0.3s ease;
        }

        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-gray);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Print styles */
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            
            .header-section, .button-group, .time-frame-panel {
                display: none !important;
            }
            
            .table-container {
                box-shadow: none;
                overflow: visible;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
            }
            
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <h1>Staff Rota Management</h1>
        
        <div class="header-section">
            <div class="week-navigation">
                <input type="date" id="weekStartDate" class="date-picker" onchange="updateWeek(); fetchAndPopulateRotaTable(); updateRotaWithHolidays()">
                <button class="btn btn-primary" onclick="previousWeek()">
                    <i class="fas fa-chevron-left"></i> Previous Week
                </button>
                <button class="btn btn-primary" onclick="nextWeek()">
                    Next Week <i class="fas fa-chevron-right"></i>
                </button>
                <button class="btn btn-success" onclick="currentWeek()">
                    Current Week
                </button>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="copyFromPreviousWeek(); fetchAndPopulateRotaTable()">
                    <i class="fas fa-copy"></i> Copy From Previous Week
                </button>
                <button class="btn btn-secondary" onclick="saveRotaData()">
                    <i class="fas fa-save"></i> Save Rota
                </button>
                <button class="btn btn-danger" onclick="clearAllRotaData()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
        </div>

        <div class="table-container">
            <table id="hoursTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Last Name</th>
                        <th>Wage</th>
                        <th>Role</th>
                        <th id="mondayHeader" data-day="monday">Monday</th>
                        <th id="tuesdayHeader" data-day="tuesday">Tuesday</th>
                        <th id="wednesdayHeader" data-day="wednesday">Wednesday</th>
                        <th id="thursdayHeader" data-day="thursday">Thursday</th>
                        <th id="fridayHeader" data-day="friday">Friday</th>
                        <th id="saturdayHeader" data-day="saturday">Saturday</th>
                        <th id="sundayHeader" data-day="sunday">Sunday</th>
                        <th>Total Hours</th>
                        <th>Total Cost</th>
                    </tr>
                </thead>
                <tbody id="employeeRows">
                    <!-- Employee rows will be dynamically generated here -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4">Weekly Totals</td>
                        <td id="mondayTotal"></td>
                        <td id="tuesdayTotal"></td>
                        <td id="wednesdayTotal"></td>
                        <td id="thursdayTotal"></td>
                        <td id="fridayTotal"></td>
                        <td id="saturdayTotal"></td>
                        <td id="sundayTotal"></td>
                        <td id="weeklyHoursTotal"></td>
                        <td id="weeklyCostTotal"></td>
                    </tr>
                    <tr class="summary-row">
                        <td colspan="10"></td>
                        <td>Holiday Rate</td>
                        <td>
                            <input type="number" id="holidayPercentageInput" class="summary-input" 
                                   placeholder="%" min="0" max="100" step="0.1"
                                   onchange="saveHolidayPercentage(this.value), calculateHolidayPercentage(), calculateTotalCostWeek()">
                            %
                        </td>                
                        <td id="result-holiday"></td>
                    </tr>
                    <tr class="summary-row">
                        <td colspan="10"></td>
                        <td>Tax Rate</td>
                        <td>
                            <input type="number" id="taxPercentageInput" class="summary-input" 
                                   placeholder="%" min="0" max="100" step="0.1"
                                   onchange="saveTaxPercentage(this.value), calculateTaxPercentage(), calculateTotalCostWeek()">
                            %
                        </td>                
                        <td id="result-tax"></td>
                    </tr>
                    <tr class="summary-row">
                        <td colspan="10"></td>
                        <td>Pension Rate</td>
                        <td>
                            <input type="number" id="pensionPercentageInput" class="summary-input" 
                                   placeholder="%" min="0" max="100" step="0.1"
                                   onchange="savePensionPercentage(this.value), calculatePensionPercentage(), calculateTotalCostWeek()">
                            %
                        </td>                
                        <td id="result-pension"></td>
                    </tr>
                    <tr class="summary-row">
                        <td colspan="11"></td>
                        <td><strong>Total Weekly Cost</strong></td>              
                        <td id="totalcostweek"><strong>£0.00</strong></td>
                    </tr>                     
                </tfoot>
            </table>
        </div>
    </div>

    <div id="popupMessage" class="popup-message">Rota Updated Successfully</div>

    <!-- Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    
    <script>
    // Global variables
    let selectedCell = null;
    let selectedEmployee = null;

    // Function to show loading overlay
    function showLoading() {
        document.querySelector('.loading-overlay').style.display = 'flex';
    }

    // Function to hide loading overlay
    function hideLoading() {
        document.querySelector('.loading-overlay').style.display = 'none';
    }

    // Function to show popup message
    function showPopup(message, type = 'success') {
        const popup = document.getElementById('popupMessage');
        popup.textContent = message;
        popup.className = 'popup-message';
        
        // Set color based on type
        if (type === 'success') {
            popup.style.backgroundColor = 'var(--success-color)';
        } else if (type === 'error') {
            popup.style.backgroundColor = 'var(--danger-color)';
        } else if (type === 'warning') {
            popup.style.backgroundColor = 'var(--warning-color)';
        }
        
        popup.classList.add('show');
        
        // Hide after 3 seconds
        setTimeout(() => {
            popup.classList.remove('show');
        }, 3000);
    }

    // Function to confirm clear all data
    function confirmClearAll() {
        if (confirm('Are you sure you want to clear all rota data for this week? This action cannot be undone.')) {
            clearAllRotaData();
            showPopup('All rota data cleared', 'warning');
        }
    }

    // Function to navigate to previous week
    function previousWeek() {
        const dateInput = document.getElementById('weekStartDate');
        const currentDate = new Date(dateInput.value);
        currentDate.setDate(currentDate.getDate() - 7);
        dateInput.valueAsDate = currentDate;
        updateWeek();
        fetchAndPopulateRotaTable();
        updateRotaWithHolidays();
    }

    // Function to navigate to next week
    function nextWeek() {
        const dateInput = document.getElementById('weekStartDate');
        const currentDate = new Date(dateInput.value);
        currentDate.setDate(currentDate.getDate() + 7);
        dateInput.valueAsDate = currentDate;
        updateWeek();
        fetchAndPopulateRotaTable();
        updateRotaWithHolidays();
    }

    // Function to navigate to current week
    function currentWeek() {
        const dateInput = document.getElementById('weekStartDate');
        dateInput.valueAsDate = new Date();
        updateWeek();
        fetchAndPopulateRotaTable();
        updateRotaWithHolidays();
    }

    // Function to Calculate the Total Weekly Cost
    function calculateTotalCostWeek() {
        try {
            // Helper function to parse a value, remove £ symbol, and convert it to a float
            const parseValue = (selector) => {
                const cell = document.querySelector(selector);
                if (cell) {
                    return parseFloat(cell.textContent.replace(/[^0-9.-]+/g, '')) || 0;
                }
                return 0;
            };

            // Get the values from the relevant cells
            const pensionValue = parseValue('#result-pension');
            const taxValue = parseValue('#result-tax');
            const holidayValue = parseValue('#result-holiday');
            const totalRowValue = parseValue('#weeklyCostTotal');

            // Sum the values
            const totalCost = pensionValue + taxValue + holidayValue + totalRowValue;

            // Update the total cost in the cell #totalcostweek
            const totalCostWeekCell = document.querySelector('#totalcostweek');
            if (totalCostWeekCell) {
                totalCostWeekCell.innerHTML = `<strong>£${totalCost.toFixed(2)}</strong>`;
            } else {
                console.error('Cell with ID #totalcostweek not found.');
            }
        } catch (error) {
            console.error('Error calculating total cost for the week:', error);
        }
    }

    // Calculates the holiday percentage of the total value in a specific cell
    function calculateHolidayPercentage() {
        const percentageValue = parseFloat(document.getElementById('holidayPercentageInput').value) || 0;
        const totalValue = parseFloat(document.querySelector('#weeklyCostTotal').textContent.replace(/[^0-9.-]+/g, '')) || 0;
        const result = (percentageValue / 100) * totalValue;
        document.getElementById('result-holiday').textContent = `£${result.toFixed(2)}`;
    }

    // Calculates the tax percentage of the total value in a specific cell
    function calculateTaxPercentage() {
        const taxValue = parseFloat(document.getElementById('taxPercentageInput').value) || 0;
        const totalValue = parseFloat(document.querySelector('#weeklyCostTotal').textContent.replace(/[^0-9.-]+/g, '')) || 0;
        const result = (taxValue / 100) * totalValue;
        document.getElementById('result-tax').textContent = `£${result.toFixed(2)}`;
    }

    // Calculates the pension percentage of the total value in a specific cell
    function calculatePensionPercentage() {
        const pensionValue = parseFloat(document.getElementById('pensionPercentageInput').value) || 0;
        const totalValue = parseFloat(document.querySelector('#weeklyCostTotal').textContent.replace(/[^0-9.-]+/g, '')) || 0;
        const result = (pensionValue / 100) * totalValue;
        document.getElementById('result-pension').textContent = `£${result.toFixed(2)}`;
    }

    // Save holiday percentage dynamically when the value changes
    async function saveHolidayPercentage(percentage) {
        if (percentage === "" || percentage < 0 || percentage > 100) {
            showPopup('Please enter a valid percentage between 0 and 100', 'error');
            return;
        }

        try {
            showLoading();
            const response = await fetch('/rota/save-holiday-percentage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ holiday: percentage }),
            });

            if (response.ok) {
                showPopup('Holiday percentage saved successfully!');
            } else {
                showPopup('Failed to save holiday percentage', 'error');
            }
        } catch (error) {
            console.error('Error saving holiday percentage:', error);
            showPopup('Error saving holiday percentage', 'error');
        } finally {
            hideLoading();
        }
    }

    // Load saved holiday percentage when the page loads
    async function loadHolidayPercentage() {
        try {
            showLoading();
            const response = await fetch('/rota/get-holiday-percentage');
            if (response.ok) {
                const data = await response.json();
                const inputField = document.getElementById('holidayPercentageInput');
                inputField.value = data.holiday || ''; // Set the saved value
            } else {
                console.error('Failed to load holiday percentage.');
            }
        } catch (error) {
            console.error('Error loading holiday percentage:', error);
        } finally {
            hideLoading();
        }
    }

    // Save Tax percentage dynamically when the value changes
    async function saveTaxPercentage(percentage) {
        if (percentage === "" || percentage < 0 || percentage > 100) {
            showPopup('Please enter a valid percentage between 0 and 100', 'error');
            return;
        }
        try {
            showLoading();
            const response = await fetch('/rota/save-tax-percentage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tax: percentage }),
            });

            if (response.ok) {
                showPopup('Tax percentage saved successfully!');
            } else {
                showPopup('Failed to save tax percentage', 'error');
            }
        } catch (error) {
            console.error('Error saving tax percentage:', error);
            showPopup('Error saving tax percentage', 'error');
        } finally {
            hideLoading();
        }
    }

    // Load saved tax percentage when the page loads
    async function loadTaxPercentage() {
        try {
            showLoading();
            const response = await fetch('/rota/get-tax-percentage');
            if (response.ok) {
                const data = await response.json();
                const inputField = document.getElementById('taxPercentageInput');
                inputField.value = data.tax || ''; // Set the saved value
            } else {
                console.error('Failed to load tax percentage.');
            }
        } catch (error) {
            console.error('Error loading tax percentage:', error);
        } finally {
            hideLoading();
        }
    }

    // Save Pension percentage dynamically when the value changes
    async function savePensionPercentage(percentage) {
        if (percentage === "" || percentage < 0 || percentage > 100) {
            showPopup('Please enter a valid percentage between 0 and 100', 'error');
            return;
        }
        try {
            showLoading();
            const response = await fetch('/rota/save-pension-percentage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ pension: percentage }),
            });

            if (response.ok) {
                showPopup('Pension percentage saved successfully!');
            } else {
                showPopup('Failed to save pension percentage', 'error');
            }
        } catch (error) {
            console.error('Error saving pension percentage:', error);
            showPopup('Error saving pension percentage', 'error');
        } finally {
            hideLoading();
        }
    }

    // Load saved pension percentage when the page loads
    async function loadPensionPercentage() {
        try {
            showLoading();
            const response = await fetch('/rota/get-pension-percentage');
            if (response.ok) {
                const data = await response.json();
                const inputField = document.getElementById('pensionPercentageInput');
                inputField.value = data.pension || ''; // Set the saved value
            } else {
                console.error('Failed to load pension percentage.');
            }
        } catch (error) {
            console.error('Error loading pension percentage:', error);
        } finally {
            hideLoading();
        }
    }

    // Function to Erase Data for the selected week
    function clearAllRotaData() {
    // Clear UI time inputs
    document.querySelectorAll("#employeeRows input[type='time']").forEach(input => {
        input.value = '';
    });

    // Get the week start date (user-selected or current)
    let weekStartDate = document.getElementById('weekStartDate')?.value;
    let date = weekStartDate ? new Date(weekStartDate) : new Date();

    // Get Monday of the selected week
    const monday = getMonday(date);
    const weekDates = getWeekDates(monday); // You already have this function

    // Format dates as strings (same format used in DB e.g. 'dd/mm/yyyy (Day)')
    const formattedDays = weekDates.map(d => `${formatDate(d)} (${getDayOfWeek(d)})`);

    // Send request to backend to delete these days
    fetch('/rota2/clearWeek', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ daysToDelete: formattedDays })
    })
    .then(response => response.text())
    .then(data => {
        console.log('Cleared from database:', data);
        alert('Rota cleared successfully for this week!');
    })
    .catch(error => {
        console.error('Error clearing rota:', error);
    });
}

    // Function to display current week
    function displayCurrentWeek() {
        // Get the current date
        const currentDate = new Date();

        // Get the current day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)
        const dayOfWeek = currentDate.getDay();

        // Calculate the difference between the current date and the last Monday (start of the week)
        const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

        // Get the current week's start (Monday) date
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() + diffToMonday);

        // Create an array to hold the dates for the current week (Monday to Sunday)
        const weekDates = [];

        for (let i = 0; i < 7; i++) {
            const currentDay = new Date(startOfWeek);
            currentDay.setDate(startOfWeek.getDate() + i);

            // Format the date as dd/mm/yyyy (Day)
            const day = String(currentDay.getDate()).padStart(2, '0');
            const month = String(currentDay.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const year = currentDay.getFullYear();
            const weekday = currentDay.toLocaleDateString('en-GB', { weekday: 'long' }); // Get long weekday name

            const formattedDate = `${day}/${month}/${year} (${weekday})`;
            weekDates.push(formattedDate);
        }

        // Display the week dates in the table headers
        const headers = document.querySelectorAll('[data-day]');
        headers.forEach((header, index) => {
            header.textContent = weekDates[index];
        });
    } 

    // Function to update the table based on selected week
    function updateWeek() {
        const weekStartDate = document.getElementById('weekStartDate').value;
        const date = new Date(weekStartDate);
        
        // Ensure the date is a valid date
        if (!isNaN(date)) {
            const monday = getMonday(date);
            const weekDates = getWeekDates(monday);
            
            // Update table headers with the correct dates and day names
            updateTableHeaders(weekDates);
            getSelectedWeekStart();
        }
    }

    // Function to get the start date of the selected week (Monday)
    function getSelectedWeekStart() {
        const selectedDate = document.getElementById('weekStartDate').value;
        if (selectedDate) {
            const date = new Date(selectedDate);
            return getMonday(date);  // Use the getMonday function to find the Monday of the selected week
        } else {
            // If no date is selected, return the current week's Monday
            const currentDate = new Date();
            return getMonday(currentDate);
        }
    }

    // Function to get the date of the Monday for the selected week
    function getMonday(date) {
        const day = date.getDay(),
              diff = date.getDate() - day + (day == 0 ? -6 : 1); // Get Monday date
        return new Date(date.setDate(diff));
    }

    // Function to generate an array of dates for the week starting from Monday
    function getWeekDates(monday) {
        const weekDates = [];
        for (let i = 0; i < 7; i++) {
            const day = new Date(monday);
            day.setDate(monday.getDate() + i);
            weekDates.push(day);
        }
        return weekDates;
    }

    // Function to update table headers with correct day format (dd/mm/yyyy (day))
    function updateTableHeaders(weekDates) {
        const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        
        // Loop through the days and update the headers
        daysOfWeek.forEach((day, index) => {
            const dayHeader = document.getElementById(`${day.toLowerCase()}Header`);
            const date = weekDates[index];
            const formattedDate = formatDate(date);
            dayHeader.innerText = `${formattedDate} (${day})`;
            dayHeader.dataset.date = formattedDate;
        });
    }

    // Helper function to format the date to dd/mm/yyyy
    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-based
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    // Function to fetch employees data and populate the table
    function fetchEmployeeData() {
        showLoading();
        // Fetch employee data from the backend
        fetch('/rota/employees')
            .then(response => response.json())
            .then(employees => {
                // Call function to populate employee rows with fetched data
                populateEmployeeRows(employees);
            })
            .catch(error => {
                console.error('Error fetching employee data:', error);
                showPopup('Error fetching employee data', 'error');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // Function to populate employee rows in the table
    function populateEmployeeRows(employees) {
        // Sort employees: BOH first, then FOH, within each by position, and finally by wage (descending order)
        employees.sort((a, b) => {
            if (a.designation === 'BOH' && b.designation !== 'BOH') {
                return -1; // BOH comes first
            } else if (a.designation !== 'BOH' && b.designation === 'BOH') {
                return 1; // FOH comes after BOH
            } else {
                // Sort within the same designation by position first
                const positionOrder = { manager: 1, supervisor: 2, tm: 3 };
                const positionComparison = (positionOrder[a.position] || 4) - (positionOrder[b.position] || 4);

                if (positionComparison !== 0) {
                    return positionComparison; // Sort by position first
                }

                // If positions are the same, sort by wage (descending)
                return b.wage - a.wage;
            }
        });
        
        const employeeRowsContainer = document.getElementById('employeeRows');
        let employeeRowsHTML = '';
        employees.forEach(employee => {
            
            employeeRowsHTML += `
                <tr data-designation="${employee.designation}" data-position="${employee.position}">
                <td>${employee.name}</td>
                <td>${employee.lastName}</td>
                <td class="hidden-cell">${employee.wage}</td>
                <td>${employee.designation}</td>
                ${createTimeCells('monday')}
                ${createTimeCells('tuesday')}
                ${createTimeCells('wednesday')}
                ${createTimeCells('thursday')}
                ${createTimeCells('friday')}
                ${createTimeCells('saturday')}
                ${createTimeCells('sunday')}
                <td class="total-hours">0.00</td>
                <td class="total-spent">£0.00</td>
            </tr>
                `;
        });
        employeeRowsContainer.innerHTML = employeeRowsHTML;
        // Apply initial cell colors based on designation
        applyRowColors();
        // Add event listeners to time input fields
        addTimeInputListeners();
        // Call funtion to fetch and display rota data
        fetchAndPopulateRotaTable();
        // Function to fetch holidays from the database and color the cells in the rota table
        updateRotaWithHolidays();
    }

    // Function to create the input fields for each day, with a button to change color
    function createTimeCells(day, startTime1, endTime1, startTime2, endTime2) {
        return `
            <td class="day-cell" data-day="${day}">
                <input type="time" class="time-input" data-day="${day}" value="${startTime1 || ''}">
                <input type="time" class="time-input" data-day="${day}" value="${endTime1 || ''}"><br>
                <input type="time" class="time-input" data-day="${day}" value="${startTime2 || ''}">
                <input type="time" class="time-input" data-day="${day}" value="${endTime2 || ''}"><br>
                <button class="action-btn btn-swap" onclick="toggleColor(event, '${day}')">Swap</button>
                <button class="action-btn btn-off" onclick="writeOff(event, '${day}')">Off</button>
            </td>
        `;
    }

    // Function to Copy Entire Previous Week's Rota
    async function copyFromPreviousWeek() {
    // Get the current and previous week dates
    const currentWeekStart = getSelectedWeekStart();
    const currentWeekFormatted = formatDateWithDay(currentWeekStart);
    
    const prevWeekStart = new Date(currentWeekStart);
    prevWeekStart.setDate(prevWeekStart.getDate() - 7);
    const prevWeekFormatted = formatDateWithDay(prevWeekStart);

    // Show loading state
    showLoading('Loading previous week\'s rota...');

    try {
        // 1. First fetch the previous week's data for all days
        const fetchResponse = await fetch(`/rota/get-previous-week-rota?prevWeek=${encodeURIComponent(prevWeekFormatted)}`);
        const fetchData = await fetchResponse.json();

        if (!fetchData.success) {
            throw new Error(fetchData.message || 'Failed to fetch previous week data');
        }

        if (fetchData.data.length === 0) {
            showPopup('No data found for previous week', 'warning');
            return;
        }

        // 2. Transform the data to match exact column names and update dates
        const transformedData = fetchData.data.map(entry => {
            // Extract the day name (Monday, Tuesday, etc.)
            const dayName = entry.day.match(/\(([^)]+)\)/)[1];
            
            // Calculate the corresponding date in the current week
            const currentWeekDay = new Date(currentWeekStart);
            const dayOffset = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
                .indexOf(dayName);
            
            currentWeekDay.setDate(currentWeekStart.getDate() + dayOffset);
            
            // Format the new date with day name (dd/mm/yyyy (Dayname))
            const formattedDate = formatDate(currentWeekDay);
            const newDay = `${formattedDate} (${dayName})`;

            return {
                name: entry.name,
                lastName: entry.lastName,
                wage: entry.wage,
                designation: entry.designation,
                day: newDay, // Updated to current week's date
                startTime: entry.startTime,
                endTime: entry.endTime,
                color: entry.color
            };
        });

        // 3. Then send the properly mapped data to be inserted
        const insertResponse = await fetch('/rota/insert-copied-rota', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                currentWeek: currentWeekFormatted,
                rotaData: transformedData
            })
        });
        
        const insertResult = await insertResponse.json();

        if (!insertResult.success) {
            throw new Error(insertResult.message || 'Failed to insert copied data');
        }

        // 4. Refresh the table to show the new data
        await fetchAndPopulateRotaTable();
        showPopup('Previous week\'s rota copied successfully!', 'success');
        
    } catch (error) {
        console.error('Error copying previous week:', error);
        showPopup(`Error: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

    // Apply row colors based on employee designation and position
    function applyRowColors() {
        const rows = document.querySelectorAll('tr');
        rows.forEach(row => {
            const designation = row.getAttribute('data-designation');
            const position = row.getAttribute('data-position');
            
            // Add class based on designation
            if (designation === 'BOH') {
                row.classList.add('boh-row');
            } else if (designation === 'FOH') {
                row.classList.add('foh-row');
            }

            // Color the first four cells based on position
            const cells = row.querySelectorAll('td');
            cells.forEach((cell, index) => {
                if (index < 4) { // Only for the first four cells (name, last name, wage, designation)
                    if (position === 'manager') {
                        cell.classList.add('manager-cell');
                    } else if (position === 'supervisor') {
                        cell.classList.add('supervisor-cell');
                    }
                }
            });
        });
    }

    // Function to remove timeframes (input fields) for "Off" state
    function removeTimeFrames(cell) {
        const timeInputs = cell.querySelectorAll('input[type="time"]');
        timeInputs.forEach(input => {
            input.value = ''; // Clear the time values
            input.style.display = 'none'; // Hide the time input fields
        });
    }

    // Function to add timeframes back (input fields) for "On" state
    function addTimeFrames(cell) {
        const timeInputs = cell.querySelectorAll('input[type="time"]');
        timeInputs.forEach(input => {
            input.style.display = 'inline'; // Show the time input fields
        });
    }

    // Toggle color between Light Blue (FOH), Light Yellow (BOH), and Light Green (Holiday)
    function toggleColor(event, day) {
        const cell = event.target.closest('td');
        const currentColor = cell.style.backgroundColor;

        // Cycle through the colors in the order: Light Blue (FOH) -> Light Yellow (BOH) -> Light Green (Holiday)
        if (currentColor === 'rgb(173, 216, 230)' || currentColor === 'lightblue') { // Light Blue (FOH)
            cell.style.backgroundColor = '#fff9c4'; // Change to Light Yellow (BOH)
            addTimeFrames(cell); // Add time frames back
        } else if (currentColor === 'rgb(255, 249, 196)' || currentColor === 'lightyellow') { // Light Yellow (BOH)
            cell.style.backgroundColor = '#c8e6c9'; // Change to Light Green (Holiday)
            removeTimeFrames(cell); // Remove time frames for Holiday
        } else { // Light Green (Holiday)
            cell.style.backgroundColor = '#bbdefb'; // Change to Light Blue (FOH)
            addTimeFrames(cell); // Add time frames back
        }
    }

    // Main function to fetch and populate the rota table
    function fetchAndPopulateRotaTable() {
        showLoading();
        // Get the selected week's Monday date
        const selectedMonday = getSelectedWeekStart();
        
        // Get all the dates for the selected week (Monday to Sunday)
        const weekDates = getWeekDates(selectedMonday);
        
        // Format the week dates and create the query string
        const formattedWeekDates = weekDates.map(date => formatDateWithDay(date));
        const queryString = formattedWeekDates.join(',');

        // Fetch rota data using the dynamically created query string
        fetch(`/rota/rota?days=${queryString}`)
            .then(response => response.json())
            .then(groupedData => {
                // Clear all time input values and cell colors in the table
                document.querySelectorAll("#employeeRows input[type='time']").forEach(input => {
                    input.value = ''; // Reset the time input
                });
                document.querySelectorAll("#employeeRows td").forEach(cell => {
                    cell.style.backgroundColor = ''; // Reset the background color
                });

                // Fill in rota data for each day
                Object.keys(groupedData).forEach(day => {
                    const employees = groupedData[day];
                    if (Array.isArray(employees)) {
                        // Group entries by name and lastName
                        const employeeGroups = employees.reduce((acc, employee) => {
                            const key = `${employee.name}_${employee.lastName}`;
                            if (!acc[key]) {
                                acc[key] = [];
                            }
                            acc[key].push(employee);
                            return acc;
                        }, {});

                        Object.keys(employeeGroups).forEach(key => {
                            const [name, lastName] = key.split('_');
                            const groupedEntries = employeeGroups[key];

                            const dayOfWeek = getWeekdayFromDate(day);
                            if (!dayOfWeek) {
                                console.warn(`Invalid day format: ${day}`);
                                return;
                            }

                            const employeeRow = Array.from(document.querySelectorAll("#employeeRows tr")).find(row => {
                                const nameCell = row.children[0]?.textContent.trim();
                                const lastNameCell = row.children[1]?.textContent.trim();
                                return nameCell === name && lastNameCell === lastName;
                            });

                            if (employeeRow) {
                                const dayHeader = document.querySelector(`th[data-day="${dayOfWeek}"]`);
                                if (dayHeader) {
                                    const dayIndex = Array.from(dayHeader.parentElement.children).indexOf(dayHeader);
                                    const dayCell = employeeRow.children[dayIndex];

                                    if (dayCell) {
                                        // Combine and sort all time frames for this employee on this day
                                        const timeFrames = groupedEntries
                                            .map(entry => ({
                                                start: entry.startTime || '',
                                                end: entry.endTime || '',
                                                color: entry.color || '' // Extract the color value
                                            }))
                                            .filter(frame => frame.start) // Ensure only valid frames are considered
                                            .sort((a, b) => a.start.localeCompare(b.start)); // Sort by start time

                                        // Flatten sorted time frames into four slots for two time periods
                                        const startTime1 = timeFrames[0]?.start || '';
                                        const endTime1 = timeFrames[0]?.end || '';
                                        const startTime2 = timeFrames[1]?.start || '';
                                        const endTime2 = timeFrames[1]?.end || '';
                                        const cellColor = timeFrames[0]?.color || ''; // Get the color value

                                        // Populate the inputs with new data
                                        const timeInputs = dayCell.querySelectorAll("input[type='time']");
                                        if (timeInputs[0]) timeInputs[0].value = startTime1;
                                        if (timeInputs[1]) timeInputs[1].value = endTime1;
                                        if (timeInputs[2]) timeInputs[2].value = startTime2;
                                        if (timeInputs[3]) timeInputs[3].value = endTime2;

                                        // Apply the color to the cell
                                        if (cellColor) {
                                            dayCell.style.backgroundColor = cellColor;
                                        }
                                    } else {
                                        console.warn(`No cell found for ${dayOfWeek} in row for ${name} ${lastName}`);
                                    }
                                } else {
                                    console.warn(`No header found for day: ${dayOfWeek}`);
                                }
                            } else {
                                console.warn(`Row for employee ${name} ${lastName} not found.`);
                            }
                        });
                    } else {
                        console.error(`Data for day ${day} is not an array:`, employees);
                    }
                });

                // Apply styles and event listeners
                applyRowColors();
                // Function to calculate total daily hours and total daily spent
                updateDailySpent();
                // Function to calculate total weekly hours and total weekly spent
                updateWeeklyTotals();
                // Function to calculate total hours for a row
                updateTotalHoursForRow();
                // Function to add event listeners to time input fields
                addTimeInputListeners();
            })
            .catch(error => {
                console.error('Error fetching rota data:', error);
            })
            .finally(() => {
                hideLoading();
            });
    }

    // Extract day from full date
    function getWeekdayFromDate(dateString) {
        // Extract the day of the week from the date string (e.g., "29/11/2024 (Friday)")
        const match = dateString.match(/\((\w+)\)/);
        if (match) {
            return match[1].toLowerCase();
        } else {
            console.warn(`No weekday found in date string: ${dateString}`);
            return null;
        }
    }

    // Helper function to format the date with the day
    function formatDateWithDay(date) {
        const formattedDate = formatDate(date);  // Format as dd/mm/yyyy
        const dayOfWeek = date.toLocaleString('en-us', { weekday: 'long' }); // Get the day of the week
        return `${formattedDate} (${dayOfWeek})`;
    }

    // Add event listeners to time input fields (for example, to handle validation)
    function addTimeInputListeners() {
        const timeInputs = document.querySelectorAll('input[type="time"]');
        timeInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                const row = e.target.closest('tr');
                updateTotalHoursForRow(row);
                updateWeeklyTotals();
                updateDailySpent();
            });
        });
    }

    // Function to calculate total hours for a row
    function updateTotalHoursForRow(row) {
        let totalHours = 0;

        // Get all the time input fields for the current row (start and end times)
        const timeInputs = row.querySelectorAll('input[type="time"]');
        
        // Loop through the inputs to calculate the total hours
        for (let i = 0; i < timeInputs.length; i += 2) {
            const startTime = timeInputs[i].value;
            const endTime = timeInputs[i + 1].value;

            // If both start and end time are provided, calculate the time difference
            if (startTime && endTime) {
                const start = parseTime(startTime);
                const end = parseTime(endTime);

                if (start && end) {
                    let diff = (end - start) / (1000 * 60 * 60); // Convert milliseconds to hours
                    
                    // Handle crossing midnight
                    if (diff < 0) {
                        diff += 24; // Add 24 hours to the difference
                    }

                    totalHours += diff;
                }
            }
        }

        // Update the "Total Hours" column in the current row
        const totalHoursCell = row.querySelector('.total-hours');
        totalHoursCell.textContent = totalHours.toFixed(2); // Round to 2 decimal places

        // Get the wage for the row
        const wageCell = row.querySelector('td:nth-child(3)'); // Assuming wage is in the 3rd column
        const wage = parseFloat(wageCell.textContent);

        // Calculate the total spent
        const totalSpent = totalHours * wage;

        // Update the "Total Spent" column in the current row
        const totalSpentCell = row.querySelector('.total-spent');
        totalSpentCell.textContent = `£${totalSpent.toFixed(2)}`; // Round to 2 decimal places
    }

    // Function to calculate total weekly hours and total weekly spent
    function updateWeeklyTotals() {
        const rows = document.querySelectorAll('#employeeRows tr');
        let weeklyTotalHours = 0;
        let weeklyTotalSpent = 0;

        // Loop through each row to calculate weekly totals
        rows.forEach(row => {
            let totalHoursForRow = 0;

            // Loop through Monday to Sunday columns (columns 5 to 11 in your table)
            for (let columnIndex = 5; columnIndex <= 11; columnIndex++) {
                let totalHoursForDay = 0;

                // Select time inputs for the current column (Monday to Sunday)
                const timeInputs = row.querySelectorAll(`td:nth-child(${columnIndex}) input[type="time"]`);

                // We should have four inputs (2 start and 2 end times)
                if (timeInputs.length === 4) {
                    // Parse the start and end times for each pair (start and end)
                    for (let i = 0; i < 2; i++) {
                        const startTime = timeInputs[i * 2].value;
                        const endTime = timeInputs[i * 2 + 1].value;

                        if (startTime && endTime) {
                            const start = parseTime(startTime);
                            const end = parseTime(endTime);

                            if (start && end) {
                                let diff = (end - start) / (1000 * 60 * 60); // Convert milliseconds to hours

                                // Handle crossing midnight
                                if (diff < 0) {
                                    diff += 24; // Add 24 hours to the difference
                                }

                                totalHoursForDay += diff;
                            }
                        }
                    }
                }

                // Add total hours for the current day to the row's total hours
                totalHoursForRow += totalHoursForDay;
            }

            // Update total hours for the row
            const totalHoursCell = row.querySelector('.total-hours');
            if (totalHoursCell) {
                totalHoursCell.textContent = totalHoursForRow.toFixed(2); // Round to 2 decimal places
            }

            // Add to the overall weekly totals
            weeklyTotalHours += totalHoursForRow;

            // Get the wage from the current row (column 3)
            const wageCell = row.querySelector('td:nth-child(3)');
            const wage = parseFloat(wageCell.textContent) || 0;

            // Calculate the total spent for the row (Total Hours * Wage)
            const totalSpentForRow = totalHoursForRow * wage;
            weeklyTotalSpent += totalSpentForRow;
        });

        // Update total hours for the week
        document.getElementById('weeklyHoursTotal').textContent = weeklyTotalHours.toFixed(2);

        // Update total spent for the week
        document.getElementById('weeklyCostTotal').textContent = `£${weeklyTotalSpent.toFixed(2)}`;

        // Calculate all percentages and totals
        calculateHolidayPercentage();
        calculateTaxPercentage();
        calculatePensionPercentage();
        calculateTotalCostWeek();    
    }

    // Function to calculate total daily hours and total daily spent
    function updateDailySpent() {
        const rows = document.querySelectorAll('#employeeRows tr'); // Select all rows

        const dailyTotals = Array(7).fill(0); // Array to store total hours for each day (Monday to Sunday)
        const dailySpentTotals = Array(7).fill(0); // Array to store total spent for each day (Monday to Sunday)

        rows.forEach((row, rowIndex) => {
            let totalHoursForRow = 0;

            // Get wage for the current row
            const wageCell = row.querySelector('td:nth-child(3)');
            let wage = parseFloat(wageCell?.textContent?.trim()) || 0;

            // Loop through columns for Monday to Sunday (5 to 11)
            for (let columnIndex = 5; columnIndex <= 11; columnIndex++) {
                let totalHoursForDay = 0;

                // Select time inputs for the current column
                const timeInputs = row.querySelectorAll(`td:nth-child(${columnIndex}) input[type="time"]`);

                // Ensure there are exactly 4 time inputs (2 pairs: start and end)
                if (timeInputs.length === 4) {
                    for (let i = 0; i < 2; i++) {
                        const startTime = timeInputs[i * 2]?.value;
                        const endTime = timeInputs[i * 2 + 1]?.value;

                        if (startTime && endTime) {
                            const start = parseTime(startTime);
                            const end = parseTime(endTime);

                            if (start && end) {
                                let diff = (end - start) / (1000 * 60 * 60); // Convert ms to hours
                                if (diff < 0) diff += 24; // Handle crossing midnight

                                totalHoursForDay += diff;
                            }
                        }
                    }
                } else {
                    console.warn(`Expected 4 inputs, but found ${timeInputs.length} in column ${columnIndex}`);
                }

                totalHoursForRow += totalHoursForDay;
                dailyTotals[columnIndex - 5] += totalHoursForDay; // Add the hours to the daily total array
                dailySpentTotals[columnIndex - 5] += totalHoursForDay * wage; // Add to the total spent for the day
            }

            // Calculate total spent for the row
            const totalSpentForRow = totalHoursForRow * wage;

            // Update total spent column for the current row
            const totalSpentCell = row.querySelector('.total-spent');
            if (totalSpentCell) {
                totalSpentCell.textContent = `£${totalSpentForRow.toFixed(2)}`;
            }
        });

        // Update the daily totals in the footer
        for (let i = 0; i < 7; i++) {
            const dayCell = document.querySelector(`#${['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'][i]}Total`);
            if (dayCell) {
                dayCell.textContent = `${dailyTotals[i].toFixed(2)}h / £${dailySpentTotals[i].toFixed(2)}`;
            }
        }
    }

    // Function to parse time string (HH:mm) into a Date object
    function parseTime(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        const date = new Date();
        date.setHours(hours);
        date.setMinutes(minutes);
        date.setSeconds(0);
        date.setMilliseconds(0);
        return date;
    }

    // Function to send Rota data to the BackEnd
    function saveRotaData() {
        showLoading();
        const tableData = [];
        const rows = document.querySelectorAll("#employeeRows tr"); // Ensure correct row selector

        // Get the week start date from input (in yyyy-mm-dd format)
        let weekStartDate = document.getElementById('weekStartDate')?.value;

        // Determine the starting Monday date
        let date;
        if (weekStartDate) {
            // Parse the provided date
            date = new Date(weekStartDate);
        } else {
            // Default to the current date
            date = new Date();
        }

        // Ensure the date is valid
        if (isNaN(date)) {
            console.error("Invalid week start date.");
            showPopup('Invalid week start date', 'error');
            hideLoading();
            return;
        }

        // Get the Monday of the week (if it's not already Monday)
        const monday = getMonday(date);

        // Format the Monday date and get the day of the week
        const dayOfWeek = getDayOfWeek(monday);
        const formattedMonday = formatDate(monday);

        // Rebuild the week start date with the Monday and day of the week
        weekStartDate = `${formattedMonday} (${dayOfWeek})`;

        // Get the week dates (the full dates for the week starting from Monday)
        const weekDates = getWeekDates(monday); // Get array of full Date objects for the week

        // Iterate through each row and prepare the data
        rows.forEach(row => {
            const name = row.children[0]?.textContent.trim();
            const lastName = row.children[1]?.textContent.trim();
            const wage = row.children[2]?.textContent.trim();
            const designation = row.children[3]?.textContent.trim();

            // Iterate through each day column to extract time values and background color
            for (let i = 4; i < row.children.length - 2; i++) { // Skip last two columns
                const cell = row.children[i];
                const dayOfWeek = cell.getAttribute('data-day'); // Correct way to get data-day

                if (!dayOfWeek) continue;

                const inputs = cell.querySelectorAll("input[type='time']");
                const backgroundColor = cell.style.backgroundColor; // Extract the background color
                
                if (inputs.length < 2) continue; // Skip if there are no time inputs

                const startTime1 = inputs[0]?.value || "";
                const endTime1 = inputs[1]?.value || "";
                const startTime2 = inputs[2]?.value || "";
                const endTime2 = inputs[3]?.value || "";

                // Get the corresponding date for the current day in the week
                const currentDate = weekDates[i - 4]; // Map the index to the correct day in the week
                const formattedDate = formatDate(currentDate); // Use the formatDate function to format the date

                // Get the day of the week (e.g., "Monday", "Tuesday")
                const dayOfWeekForDate = getDayOfWeek(currentDate);

                // Combine date and day of the week into one string like "dd/mm/yyyy (Day)"
                const dayWithDayOfWeek = `${formattedDate} (${dayOfWeekForDate})`;

                // Add data to the tableData array with day and dayOfWeek combined
                if (startTime1 && endTime1) {
                    tableData.push({
                        name, lastName, wage, designation, day: dayWithDayOfWeek,
                        startTime: startTime1, endTime: endTime1, color: backgroundColor
                    });
                }
                if (startTime2 && endTime2) {
                    tableData.push({
                        name, lastName, wage, designation, day: dayWithDayOfWeek,
                        startTime: startTime2, endTime: endTime2, color: backgroundColor
                    });
                }
            }
        });

        // Send data to the backend using fetch API (adjust the URL to your backend)
        fetch('/rota/saveData', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(tableData),
        })
        .then(response => {
            if (response.ok) {
                return response.text();
            }
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            console.log('Response from server:', data);
            showPopup('Rota saved successfully!');
        })
        .catch(error => {
            console.error('Error:', error);
            showPopup('Error saving rota data', 'error');
        })
        .finally(() => {
            hideLoading();
        });
    }

    // Function to fetch holidays from the database and color the cells in the rota table
    function updateRotaWithHolidays() {
        showLoading();
        // Fetch accepted holidays from the backend
        fetch('/rota/holidays')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned status ${response.status}`);
                }
                return response.json();
            })
            .then(holidays => {
                console.log('Raw data from the server:', holidays);

                if (!Array.isArray(holidays)) {
                    console.error('Expected an array, but received:', holidays);
                    return;
                }

                holidays.forEach(holiday => {
                    try {
                        const { name, lastname, startDate, endDate } = holiday;

                        // Validate required fields before processing
                        if (!name || !lastname || !startDate || !endDate) {
                            console.error('Invalid holiday data:', holiday);
                            return;
                        }

                        console.log(`Processing holiday for ${name} ${lastname} from ${startDate} to ${endDate}`);

                        // Function to format date as dd/mm/yyyy (Day)
                        const formatDate = (dateStr) => {
                            const [day, month, yearWithDay] = dateStr.split('/');
                            const [year, dayOfWeek] = yearWithDay.split(' ');
                            return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year} ${dayOfWeek.trim()}`;
                        };

                        // Convert startDate and endDate to Date objects
                        const [startDay, startMonth, startYearWithDay] = startDate.split('/');
                        const [startYear, startDayOfWeek] = startYearWithDay.split(' ');
                        const startDateObj = new Date(`${startMonth}/${startDay}/${startYear}`);

                        const [endDay, endMonth, endYearWithDay] = endDate.split('/');
                        const [endYear, endDayOfWeek] = endYearWithDay.split(' ');
                        const endDateObj = new Date(`${endMonth}/${endDay}/${endYear}`);

                        console.log('Formatted start date:', startDateObj, 'Formatted end date:', endDateObj);

                        // Loop through the days in the range
                        let currentDateObj = new Date(startDateObj);
                        while (currentDateObj <= endDateObj) {
                            // Format currentDate as dd/mm/yyyy (Day)
                            const currentDate = formatDate(`${currentDateObj.getDate()}/${currentDateObj.getMonth() + 1}/${currentDateObj.getFullYear()} (${currentDateObj.toLocaleDateString('en-GB', { weekday: 'long' })})`);

                            console.log('Checking date:', currentDate);

                            // Find the row for the employee
                            const row = Array.from(document.querySelectorAll('tr')).find(row => {
                                const firstNameCell = row.children[0]; // First column contains the name
                                const lastNameCell = row.children[1]; // Second column contains the last name

                                // Log the first and last names from the table
                                const firstNameText = firstNameCell ? firstNameCell.textContent.trim().toLowerCase() : '';
                                const lastNameText = lastNameCell ? lastNameCell.textContent.trim().toLowerCase() : '';
                                console.log(`Checking row: ${firstNameText} ${lastNameText}`);

                                return firstNameText === name.toLowerCase() && lastNameText === lastname.toLowerCase();  // Compare names case-insensitively
                            });

                            if (row) {
                                console.log(`Found row for ${name} ${lastname}`);

                                // Loop through the header cells to find the matching date
                                const headerCells = document.querySelectorAll('#hoursTable thead th');
                                headerCells.forEach(cell => {
                                    const cellDateText = cell.textContent.trim(); // Get the cell's text content (date with day of week)

                                    // Skip non-date cells like "Total Hours" or "Total Spent"
                                    if (cellDateText.toLowerCase().includes('total')) {
                                        return;  // Skip this iteration for non-date cells
                                    }

                                    // Normalize the day of the week (capitalize the first letter of the weekday)
                                    const normalizedCellDateText = cellDateText.replace(/\(\w/, (match) => match.toUpperCase());

                                    console.log(`Cell date: ${normalizedCellDateText}, Comparing with current date: ${currentDate}`);

                                    // Check if the cell's date matches the full date (dd/mm/yyyy (day))
                                    if (normalizedCellDateText === currentDate) {
                                        console.log(`Found cell for ${currentDate}. Clearing and coloring.`);

                                        // Find the corresponding cell in the row
                                        const dayIndex = Array.from(cell.parentElement.children).indexOf(cell);
                                        const dateCell = row.children[dayIndex];

                                        if (dateCell) {
                                            // Clear inputs and set holiday color
                                            const inputs = dateCell.querySelectorAll('input[type="time"]');
                                            inputs.forEach(input => input.value = '');
                                            dateCell.classList.add('holiday-cell');
                                        }
                                    }
                                });
                            } else {
                                console.log(`No row found for ${name} ${lastname}`);
                            }

                            // Increment the date (dd/mm/yyyy format)
                            currentDateObj.setDate(currentDateObj.getDate() + 1);  // Move to the next day
                        }
                    } catch (error) {
                        console.error('Error processing holiday:', holiday, error);
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching holidays:', error);
                showPopup('Error fetching holiday data', 'error');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // Function to handle the Write Off button click (toggle behavior)
    function writeOff(event, dayIndex) {
        const cell = event.target.closest('td');
        const button = event.target; // Reference to the Write Off button
        const row = cell.closest('tr'); // Get the row for this particular employee

        // Extract employee information (name, last name, etc.) from the row
        const name = row.children[0].textContent.trim(); // First cell for employee's name
        const lastName = row.children[1].textContent.trim(); // Second cell for employee's last name

        // Get the week start date from input (in yyyy-mm-dd format)
        let weekStartDate = document.getElementById('weekStartDate')?.value;

        // Determine the starting Monday date
        let date;
        if (weekStartDate) {
            // Parse the provided date
            date = new Date(weekStartDate);
        } else {
            // Default to the current date
            date = new Date();
        }

        // Ensure the date is valid
        if (isNaN(date)) {
            console.error("Invalid week start date.");
            showPopup('Invalid week start date', 'error');
            return;
        }

        // Get the Monday of the week (if it's not already Monday)
        const monday = getMonday(date);

        // Format the Monday date and get the day of the week
        const dayOfWeek = getDayOfWeek(monday);
        const formattedMonday = formatDate(monday);

        // Rebuild the week start date with the Monday and day of the week
        weekStartDate = `${formattedMonday} (${dayOfWeek})`;

        // Debug: log the formatted date with the day
        console.log("Formatted Week Start Date:", weekStartDate);

        // Get the week dates (the full dates for the week starting from Monday)
        const weekDates = getWeekDates(monday); // Get array of full Date objects for the week

        // Check if the weekDates array is valid
        if (!Array.isArray(weekDates) || weekDates.length !== 7) {
            console.error("Invalid weekDates:", weekDates);
            return;
        }

        // Create a mapping from day name to index
        const dayMapping = {
            "monday": 0,
            "tuesday": 1,
            "wednesday": 2,
            "thursday": 3,
            "friday": 4,
            "saturday": 5,
            "sunday": 6
        };

        // Ensure the dayIndex is valid and mapped to the correct number
        const validDayIndex = dayMapping[dayIndex.toLowerCase()];
        if (validDayIndex === undefined) {
            console.error("Invalid dayIndex:", dayIndex);
            return;
        }

        // Log dayIndex to check if it is within bounds
        console.log("dayIndex:", validDayIndex);

        // Get the specific date for the provided day index
        const currentDate = weekDates[validDayIndex]; // Get the date for the given day index
        console.log("currentDate:", currentDate);

        // Check if currentDate is a valid Date object
        if (!(currentDate instanceof Date) || isNaN(currentDate.getTime())) {
            console.error("Invalid currentDate:", currentDate);
            return;
        }

        // Format the currentDate and get the day of the week
        const formattedDate = formatDate(currentDate); // Format as dd/mm/yyyy
        const currentDayOfWeek = getDayOfWeek(currentDate); // Get the day name (e.g., Monday)

        // Log the formatted date and day of the week for debugging
        console.log("formattedDate:", formattedDate, "currentDayOfWeek:", currentDayOfWeek);

        const fullDay = `${formattedDate} (${currentDayOfWeek})`; // Combine date and day name

        // Check the current state of the button (whether it is "ON" or "OFF")
        if (button.classList.contains('off')) {
            // If the button is currently "OFF", change it to "ON"
            button.classList.remove('off');
            button.textContent = 'Off'; // Change the button text back to "Off"

            // Show the timeframes again (if not already added)
            addTimeFrames(cell);
        } else {
            // If the button is currently "ON", change it to "OFF"
            button.classList.add('off');
            button.textContent = 'On'; // Change the button text to "On"

            // Clear (remove) the timeframes from the cell
            removeTimeFrames(cell);

            // Make a request to the backend to remove the data for this day and employee
            removeDayDataFromDB(name, lastName, fullDay);
        }

        // Call the functions to update totals and daily values after toggling the button
        updateTotalHoursForRow(row); // Update total hours and total spent for the current row
        updateWeeklyTotals(); // Update weekly totals
        updateDailySpent(); // Update daily totals
    }

    // Function to remove data for a specific day and employee from the database
    function removeDayDataFromDB(name, lastName, fullDay) {
        showLoading();
        // Prepare the data to send to the backend
        const requestData = {
            name,
            lastName,
            fullDay,
        };
        console.log('Day: ',fullDay,
                'Name: ',name,
                'Lastname: ',lastName
            )
        // Use fetch to send a DELETE request to the backend
        fetch('/rota/removeDayData', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Failed to remove data from the database.');
            })
            .then(data => {
                console.log('Data removed successfully:', data);
                showPopup('Day data removed successfully');
            })
            .catch(error => {
                console.error('Error removing data:', error);
                showPopup('Error removing day data', 'error');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // Function to get the day of the week (e.g., "Monday", "Tuesday", etc.)
    function getDayOfWeek(date) {
        const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        return daysOfWeek[date.getDay()];
    }

    // Function to clear all data in the rota table
    function clearAllRotaData() {
    // Clear UI time inputs
    document.querySelectorAll("#employeeRows input[type='time']").forEach(input => {
        input.value = '';
    });

    // Get the week start date (user-selected or current)
    let weekStartDate = document.getElementById('weekStartDate')?.value;
    let date = weekStartDate ? new Date(weekStartDate) : new Date();

    // Get Monday of the selected week
    const monday = getMonday(date);
    const weekDates = getWeekDates(monday); // You already have this function

    // Format dates as strings (same format used in DB e.g. 'dd/mm/yyyy (Day)')
    const formattedDays = weekDates.map(d => `${formatDate(d)} (${getDayOfWeek(d)})`);

    // Send request to backend to delete these days
    fetch('/rota/clearWeek', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ daysToDelete: formattedDays })
    })
    .then(response => response.text())
    .then(data => {
        console.log('Cleared from database:', data);
        alert('Rota cleared successfully for this week!');
    })
    .catch(error => {
        console.error('Error clearing rota:', error);
    });
}
    
    // Function to add time frame to selected cell
    function addTime() {
        if (!selectedCell) {
            showPopup('Please select a cell first', 'warning');
            return;
        }

        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;

        if (!startTime || !endTime) {
            showPopup('Please enter both start and end times', 'warning');
            return;
        }

        const inputs = selectedCell.querySelectorAll('input[type="time"]');
        let emptySlotFound = false;

        // Find the first empty time slot
        for (let i = 0; i < inputs.length; i += 2) {
            if (!inputs[i].value && !inputs[i + 1].value) {
                inputs[i].value = startTime;
                inputs[i + 1].value = endTime;
                emptySlotFound = true;
                break;
            }
        }

        if (!emptySlotFound) {
            showPopup('All time slots are already filled', 'warning');
            return;
        }

        // Update totals
        const row = selectedCell.closest('tr');
        updateTotalHoursForRow(row);
        updateWeeklyTotals();
        updateDailySpent();

        showPopup('Time frame added successfully');
        hideTimeFramePanel();
    }

    // Function to delete time frame from selected cell
    function deleteTime() {
        if (!selectedCell) {
            showPopup('Please select a cell first', 'warning');
            return;
        }

        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;

        const inputs = selectedCell.querySelectorAll('input[type="time"]');
        let timeFound = false;

        // Find and clear matching time slots
        for (let i = 0; i < inputs.length; i += 2) {
            if (inputs[i].value === startTime && inputs[i + 1].value === endTime) {
                inputs[i].value = '';
                inputs[i + 1].value = '';
                timeFound = true;
            }
        }

        if (!timeFound) {
            showPopup('The specified time frame was not found', 'warning');
            return;
        }

        // Update totals
        const row = selectedCell.closest('tr');
        updateTotalHoursForRow(row);
        updateWeeklyTotals();
        updateDailySpent();

        showPopup('Time frame deleted successfully');
        hideTimeFramePanel();
    }

    // Initialize the application
    function init() {
        // Set default date to today
        document.getElementById('weekStartDate').valueAsDate = new Date();
        
        // Add click event to day cells for time frame management
        document.querySelectorAll('.day-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                // Remove previous selection
                document.querySelectorAll('.day-cell').forEach(c => {
                    c.classList.remove('selected');
                });
                
                // Set new selection
                this.classList.add('selected');
                selectedCell = this;
                
                // Get employee info
                const row = this.closest('tr');
                selectedEmployee = {
                    name: row.children[0].textContent.trim(),
                    lastName: row.children[1].textContent.trim()
                };
            });
        });

        // Fetch employee data when the page loads
        fetchEmployeeData();
        
        // Display Current Week
        displayCurrentWeek();
        
        // Load saved percentages
        loadHolidayPercentage();
        loadTaxPercentage();
        loadPensionPercentage();
        
        // Calculate initial totals
        calculateTotalCostWeek();
    }

    // Window on Load function call
    window.onload = init;
    </script>
</body>
</html>